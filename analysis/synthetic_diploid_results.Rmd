---
title: "Synthetic Diploid Results"
author: "Andy Beck"
date: "2024-05-15"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Libraries and Directories

```{r}
library(tidyverse)
library(janitor)
library(reactable)
source("code/common_functions.R")
library(yaml)
library(gtsummary)

library(grid)
library(gridExtra) 

config_obj <- yaml::read_yaml("_config.yaml")

eagle_switch_dir <-   paste0(config_obj$base_dir,"/output/switch_errors/switch_errors/eagle/annotated/")
shapeit_switch_dir <- paste0(config_obj$base_dir,"/output/switch_errors/switch_errors/shapeit/annotated/")
beagle_switch_dir <-  paste0(config_obj$base_dir,"/output/switch_errors/switch_errors/beagle/annotated/")
num_sites_dir <-      paste0(config_obj$base_dir,"/output/switch_errors/vcf_n_sites/")
het_loc_dir <-        paste0(config_obj$base_dir,"/output/switch_errors/het_loc/")

sample_info_df <- read_csv("data/1kgp/subject_info.csv") %>%
  select(SAMPLE_NAME, POPULATION, SUPER)

pair_info_df <- read_delim("data/sample_pairs.csv", col_names = c("POP", "ID1", "ID2"))
pair_info_df <- left_join(pair_info_df, sample_info_df, by = c("ID1"="SAMPLE_NAME")) %>%
  rename(SP = SUPER) %>%
  select(-POPULATION)

# data/chrX_gc1kb_pilot.bed
gc_content_1kb <- read_tsv("data/chrX_gc1kb_pilot.bed")
colnames(gc_content_1kb) <- c("CHR", "START", "END", "AT", "GC", "A", "C", "G", "T", "TOTAL", "OTHER", "LENGTH")
gc_content_1kb  <- gc_content_1kb %>%
  mutate(bin_id = (START / 1000) + 1)

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000")

maf_prop_df <- read_csv(paste0(config_obj$base_dir,"/output/switch_errors/maf_props.csv"))
pair_info_df$id <- 1:1000
maf_prop_df <- left_join(maf_prop_df, {pair_info_df %>% select(id, SP, POP)})
pair_info_df <- pair_info_df %>% select(id)
#regen
```


## Introduction

In this document, we present summaries and figures for the distributions of errors in phasing of our synthetic X chromosome diploids.

## Load Switch and Flips Errors

```{r}
df_vcftools <- read_csv(paste0(config_obj$base_dir,"/output/switch_errors/switch_errors/summary.csv"))
```

## Tables

### Mean error rates

Total errors:

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) ,
         Eagle = (n_other_eagle + n_flip_eagle) ,
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) ) %>%
  tbl_summary(include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```

By population:

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) ,
         Eagle = (n_other_eagle + n_flip_eagle) ,
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) ) %>%
  tbl_summary(by = pop,
              include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```

Errors per het:

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) / n_hets ,
         Eagle = (n_other_eagle + n_flip_eagle) / n_hets ,
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets ) %>%
  tbl_summary(include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

df_vcftools %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) / n_hets ,
         Eagle = (n_other_eagle + n_flip_eagle) / n_hets ,
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets ) %>%
  tbl_summary(by = pop,
              include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```

Errors per MB:

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) / size_mb ,
         Eagle = (n_other_eagle + n_flip_eagle) / size_mb ,
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / size_mb ) %>%
  tbl_summary(include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

df_vcftools %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) / size_mb ,
         Eagle = (n_other_eagle + n_flip_eagle) / size_mb ,
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / size_mb ) %>%
  tbl_summary(by = pop,
              include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```

### Mean number of switches and flips

```{r}
df_vcftools %>%
  summarize(mean_switch_eagle = mean(n_other_eagle),
            mean_switch_beagle = mean(n_other_beagle),
            mean_switch_shapeit = mean(n_other_shapeit),
            mean_flip_eagle = mean(n_flip_eagle),
            mean_flip_beagle = mean(n_flip_beagle),
            mean_flip_shapeit = mean(n_flip_shapeit)) %>%
  knitr::kable()
```

#### By population

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_switch_eagle = mean(n_other_eagle),
            mean_switch_beagle = mean(n_other_beagle),
            mean_switch_shapeit = mean(n_other_shapeit),
            mean_flip_eagle = mean(n_flip_eagle),
            mean_flip_beagle = mean(n_flip_beagle),
            mean_flip_shapeit = mean(n_flip_shapeit)) %>%
  knitr::kable()
```

### Mean number of switches and flips per MB

```{r}
df_vcftools %>%
  mutate(Beagle_switch = n_other_beagle / size_mb,
         Eagle_switch = n_other_eagle / size_mb,
         SHAPEIT_switch = n_other_shapeit / size_mb,
         Beagle_flip = n_other_beagle / size_mb,
         Eagle_flip = n_other_eagle / size_mb,
         SHAPEIT_flip = n_other_shapeit / size_mb) %>%
  tbl_summary(include = c(Beagle_switch, Eagle_switch, SHAPEIT_switch,
                          Beagle_flip, Eagle_flip, SHAPEIT_flip),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```

#### By population

```{r}
df_vcftools %>%
  mutate(Beagle_switch = n_other_beagle / size_mb,
         Eagle_switch = n_other_eagle / size_mb,
         SHAPEIT_switch = n_other_shapeit / size_mb,
         Beagle_flip = n_other_beagle / size_mb,
         Eagle_flip = n_other_eagle / size_mb,
         SHAPEIT_flip = n_other_shapeit / size_mb) %>%
  tbl_summary(by = pop,
    include = c(Beagle_switch, Eagle_switch, SHAPEIT_switch,
                          Beagle_flip, Eagle_flip, SHAPEIT_flip),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```


### Mean number of switches and flips per heterozygous site

```{r}
df_vcftools %>%
  mutate(Beagle_switch = n_other_beagle / n_hets,
         Eagle_switch = n_other_eagle / n_hets,
         SHAPEIT_switch = n_other_shapeit / n_hets,
         Beagle_flip = n_other_beagle / n_hets,
         Eagle_flip = n_other_eagle / n_hets,
         SHAPEIT_flip = n_other_shapeit / n_hets) %>%
  tbl_summary(include = c(Beagle_switch, Eagle_switch, SHAPEIT_switch,
                          Beagle_flip, Eagle_flip, SHAPEIT_flip),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```

#### By population

```{r}
df_vcftools %>%
  mutate(Beagle_switch = n_other_beagle / n_hets,
         Eagle_switch = n_other_eagle / n_hets,
         SHAPEIT_switch = n_other_shapeit / n_hets,
         Beagle_flip = n_other_beagle / n_hets,
         Eagle_flip = n_other_eagle / n_hets,
         SHAPEIT_flip = n_other_shapeit / n_hets) %>%
  tbl_summary(by = pop,
    include = c(Beagle_switch, Eagle_switch, SHAPEIT_switch,
                          Beagle_flip, Eagle_flip, SHAPEIT_flip),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```


### Mean median number of heterozygous sites between errors

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_het_switch_beagle = mean(med_hets_switch_beagle),
            mean_het_switch_eagle = mean(med_hets_switch_eagle),
            mean_het_switch_shapeit = mean(med_hets_switch_shapeit)) %>%
  knitr::kable()
```

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_het_flip_beagle = mean(med_hets_flip_beagle),
            mean_het_flip_eagle = mean(med_hets_flip_eagle),
            mean_het_flip_shapeit = mean(med_hets_flip_shapeit)) %>%
  knitr::kable()
```

Note here that the populations will also differ in regards to the mean number of heterozygous sites in each pseudo-diploid:

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_n_het = mean(n_hets),
            sd_n_het = sd(n_hets)) %>%
  knitr::kable()
```

### Mean mean number of heterozygous sites between errors

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_het_switch_beagle = mean(mean_hets_switch_beagle),
            mean_het_switch_eagle = mean(mean_hets_switch_eagle),
            mean_het_switch_shapeit = mean(mean_hets_switch_shapeit)) %>%
  knitr::kable()
```

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_het_flip_beagle = mean(mean_hets_flip_beagle),
            mean_het_flip_eagle = mean(mean_hets_flip_eagle),
            mean_het_flip_shapeit = mean(mean_hets_flip_shapeit)) %>%
  knitr::kable()
```

### Errors at CpGs

#### Total

```{r}
df_vcftools %>%
  summarize(mean_switch_eagle = mean(n_other_cpg_eagle),
            mean_switch_beagle = mean(n_other_cpg_beagle),
            mean_switch_shapeit = mean(n_other_cpg_shapeit),
            mean_flip_eagle = mean(n_flip_cpg_eagle),
            mean_flip_beagle = mean(n_flip_cpg_beagle),
            mean_flip_shapeit = mean(n_flip_cpg_shapeit)) %>%
  knitr::kable()
```

##### By Population

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_switch_eagle = mean(n_other_cpg_eagle),
            mean_switch_beagle = mean(n_other_cpg_beagle),
            mean_switch_shapeit = mean(n_other_cpg_shapeit),
            mean_flip_eagle = mean(n_flip_cpg_eagle),
            mean_flip_beagle = mean(n_flip_cpg_beagle),
            mean_flip_shapeit = mean(n_flip_cpg_shapeit)) %>%
  knitr::kable()
```

#### Proportions

```{r}
df_vcftools %>%
  summarize(mean_switch_eagle = mean(n_other_cpg_eagle / n_other_eagle),
            mean_switch_beagle = mean(n_other_cpg_beagle / n_other_beagle),
            mean_switch_shapeit = mean(n_other_cpg_shapeit / n_other_shapeit),
            mean_flip_eagle = mean(n_flip_cpg_eagle / n_flip_eagle),
            mean_flip_beagle = mean(n_flip_cpg_beagle / n_flip_beagle),
            mean_flip_shapeit = mean(n_flip_cpg_shapeit / n_flip_shapeit)) %>%
  knitr::kable()
```

##### By Population

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_switch_eagle = mean(n_other_cpg_eagle / n_other_eagle),
            mean_switch_beagle = mean(n_other_cpg_beagle / n_other_beagle),
            mean_switch_shapeit = mean(n_other_cpg_shapeit / n_other_shapeit),
            mean_flip_eagle = mean(n_flip_cpg_eagle / n_flip_eagle),
            mean_flip_beagle = mean(n_flip_cpg_beagle / n_flip_beagle),
            mean_flip_shapeit = mean(n_flip_cpg_shapeit / n_flip_shapeit)) %>%
  knitr::kable()
```

#### Enrichment

We compute the ratio of the proportion of errors at CpGs to the proportion of heterozygous locations that are at CpGs.

```{r}
df_vcftools %>%
  summarize(mean_switch_eagle = mean((n_other_cpg_eagle / n_other_eagle) / ( n_het_cpg / n_hets)),
            mean_switch_beagle = mean((n_other_cpg_beagle / n_other_beagle) / ( n_het_cpg / n_hets)),
            mean_switch_shapeit = mean((n_other_cpg_shapeit / n_other_shapeit) / ( n_het_cpg / n_hets) ),
            mean_flip_eagle = mean((n_flip_cpg_eagle / n_flip_eagle) / ( n_het_cpg / n_hets)),
            mean_flip_beagle = mean((n_flip_cpg_beagle / n_flip_beagle) / ( n_het_cpg / n_hets)),
            mean_flip_shapeit = mean((n_flip_cpg_shapeit / n_flip_shapeit) / ( n_het_cpg / n_hets))) %>%
  knitr::kable()
```

Alternative view: odds ratios

```{r}
df_vcftools %>%
  mutate( prop_cpg_beagle =  n_other_cpg_beagle / n_other_beagle,
             prop_cpg_eagle =  n_other_cpg_eagle / n_other_eagle,
             prop_cpg_shapeit =  n_other_cpg_shapeit / n_other_shapeit) %>%
  mutate(ods_beagle = prop_cpg_beagle / (1 - prop_cpg_beagle),
         ods_eagle = prop_cpg_eagle / (1 - prop_cpg_eagle),
         ods_shapeit = prop_cpg_shapeit / (1 - prop_cpg_shapeit),
         ods_het = ( n_het_cpg / n_hets) / (1 - ( n_het_cpg / n_hets))) %>%
  mutate(Beagle = ods_beagle / ods_het,
         Eagle = ods_eagle / ods_het,
         SHAPEIT = ods_shapeit / ods_het) %>%
  select(pop, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(-pop, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR, colour = pop)) +
  geom_boxplot() +
  ylab("Odds CpG Switch / Odds CpG Het") +
  ggtitle("Odds Ratio of CpG Status for Switches") +
  theme_classic() +
  labs(colour = "Population") +
  scale_color_manual(values = cbPalette) +
  geom_hline(yintercept = 1, linetype=2)

df_vcftools %>%
  mutate( prop_cpg_beagle =  n_other_cpg_beagle / n_other_beagle,
             prop_cpg_eagle =  n_other_cpg_eagle / n_other_eagle,
             prop_cpg_shapeit =  n_other_cpg_shapeit / n_other_shapeit) %>%
  mutate(ods_beagle = prop_cpg_beagle / (1 - prop_cpg_beagle),
         ods_eagle = prop_cpg_eagle / (1 - prop_cpg_eagle),
         ods_shapeit = prop_cpg_shapeit / (1 - prop_cpg_shapeit),
         ods_het = ( n_het_cpg / n_hets) / (1 - ( n_het_cpg / n_hets))) %>%
  mutate(Beagle = ods_beagle / ods_het,
         Eagle = ods_eagle / ods_het,
         SHAPEIT = ods_shapeit / ods_het) %>%
  select(pop, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(-pop, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR)) +
  geom_boxplot() +
  ylab("Odds CpG Switch / Odds CpG Het") +
  ggtitle("Odds Ratio of CpG Status for Switches") +
  theme_classic() +
  scale_color_manual(values = cbPalette) +
  geom_hline(yintercept = 1, linetype=2)
```

And flips:

```{r}
df_vcftools %>%
  mutate( prop_cpg_beagle =  n_flip_cpg_beagle / n_flip_beagle,
             prop_cpg_eagle =  n_flip_cpg_eagle / n_flip_eagle,
             prop_cpg_shapeit =  n_flip_cpg_shapeit / n_flip_shapeit) %>%
  mutate(ods_beagle = prop_cpg_beagle / (1 - prop_cpg_beagle),
         ods_eagle = prop_cpg_eagle / (1 - prop_cpg_eagle),
         ods_shapeit = prop_cpg_shapeit / (1 - prop_cpg_shapeit),
         ods_het = ( n_het_cpg / n_hets) / (1 - ( n_het_cpg / n_hets))) %>%
  mutate(Beagle = ods_beagle / ods_het,
         Eagle = ods_eagle / ods_het,
         SHAPEIT = ods_shapeit / ods_het) %>%
  select(pop, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(-pop, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR, colour = pop)) +
  geom_boxplot() +
  ylab("Odds CpG Switch / Odds CpG Het") +
  ggtitle("Odds Ratio of CpG Status for Switches") +
  theme_classic() +
  labs(colour = "Population") +
  scale_color_manual(values = cbPalette) +
  geom_hline(yintercept = 1, linetype=2)

df_vcftools %>%
  mutate( prop_cpg_beagle =  n_flip_cpg_beagle / n_flip_beagle,
             prop_cpg_eagle =  n_flip_cpg_eagle / n_flip_eagle,
             prop_cpg_shapeit =  n_flip_cpg_shapeit / n_flip_shapeit) %>%
  mutate(ods_beagle = prop_cpg_beagle / (1 - prop_cpg_beagle),
         ods_eagle = prop_cpg_eagle / (1 - prop_cpg_eagle),
         ods_shapeit = prop_cpg_shapeit / (1 - prop_cpg_shapeit),
         ods_het = ( n_het_cpg / n_hets) / (1 - ( n_het_cpg / n_hets))) %>%
  mutate(Beagle = ods_beagle / ods_het,
         Eagle = ods_eagle / ods_het,
         SHAPEIT = ods_shapeit / ods_het) %>%
  select(pop, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(-pop, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR)) +
  geom_boxplot() +
  ylab("Odds CpG Switch / Odds CpG Het") +
  ggtitle("Odds Ratio of CpG Status for Switches") +
  theme_classic() +
  scale_color_manual(values = cbPalette) +
  geom_hline(yintercept = 1, linetype=2)

```


##### By Population

```{r}
df_vcftools %>%
  group_by(pop) %>%
  summarize(mean_switch_eagle = mean((n_other_cpg_eagle / n_other_eagle) / ( n_het_cpg / n_hets)),
            mean_switch_beagle = mean((n_other_cpg_beagle / n_other_beagle) / ( n_het_cpg / n_hets)),
            mean_switch_shapeit = mean((n_other_cpg_shapeit / n_other_shapeit) / ( n_het_cpg / n_hets) ),
            mean_flip_eagle = mean((n_flip_cpg_eagle / n_flip_eagle) / ( n_het_cpg / n_hets)),
            mean_flip_beagle = mean((n_flip_cpg_beagle / n_flip_beagle) / ( n_het_cpg / n_hets)),
            mean_flip_shapeit = mean((n_flip_cpg_shapeit / n_flip_shapeit) / ( n_het_cpg / n_hets))) %>%
  knitr::kable()
```

## Figures

### Total Errors

```{r include=FALSE}
b_l_e <- df_vcftools %>%
  mutate(Beagle = n_other_beagle + n_flip_beagle,
         Eagle = n_other_eagle + n_flip_eagle, 
         SHAPEIT = n_other_shapeit + n_flip_shapeit) %>%
  mutate(b_l_e = Beagle < Eagle) %>%
  pull(b_l_e) %>%
  sum()

s_l_e <- df_vcftools %>%
  mutate(Beagle = n_other_beagle + n_flip_beagle,
         Eagle = n_other_eagle + n_flip_eagle, 
         SHAPEIT = n_other_shapeit + n_flip_shapeit) %>%
  mutate(b_l_e = SHAPEIT < Eagle) %>%
  pull(b_l_e) %>%
  sum()

s_l_b <- df_vcftools %>%
  mutate(Beagle = n_other_beagle + n_flip_beagle,
         Eagle = n_other_eagle + n_flip_eagle, 
         SHAPEIT = n_other_shapeit + n_flip_shapeit) %>%
  mutate(b_l_e = SHAPEIT < Beagle) %>%
  pull(b_l_e) %>%
  sum()

b_l_s <- df_vcftools %>%
  mutate(Beagle = n_other_beagle + n_flip_beagle,
         Eagle = n_other_eagle + n_flip_eagle, 
         SHAPEIT = n_other_shapeit + n_flip_shapeit) %>%
  mutate(b_l_s = SHAPEIT > Beagle) %>%
  pull(b_l_s) %>%
  sum()
```


Comparing Eagle to Beagle, we observed a higher number of errors in Eagle in `r b_l_e` synthetic diploids, while for SHAPEIT and Eagle we see more errors in Eagle than in SHAPEIT in `r s_l_e` synthetic diploids.

```{r}
df_vcftools %>%
  mutate(Beagle = n_other_beagle + n_flip_beagle,
         Eagle = n_other_eagle + n_flip_eagle, 
         SHAPEIT = n_other_shapeit + n_flip_shapeit) %>%
  ggplot(aes(x = Beagle, y = Eagle, color = pop)) +
  geom_point() +
  ggtitle("Total Errors") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette) +
  labs(color = "Population")
```

```{r}
df_vcftools %>%
  mutate(Beagle = n_other_beagle + n_flip_beagle,
         Eagle = n_other_eagle + n_flip_eagle, 
         SHAPEIT = n_other_shapeit + n_flip_shapeit) %>%
  ggplot(aes(x = Beagle, y = SHAPEIT, color = pop)) +
  geom_point() +
  ggtitle("Total Errors") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
  mutate(Beagle = n_other_beagle + n_flip_beagle,
         Eagle = n_other_eagle + n_flip_eagle, 
         SHAPEIT = n_other_shapeit + n_flip_shapeit) %>%
  ggplot(aes(x = Eagle, y = SHAPEIT, color = pop)) +
  geom_point() +
  ggtitle("Total Errors") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

All in one figure:

```{r}
cross_meth_plot <- function(df, p_title) {
  p1 <- df %>%
    ggplot(aes(x = Beagle, y = Eagle, color = pop)) +
    geom_point() +
    theme_classic() +
    geom_abline(slope = 1, intercept = 0) +
    scale_color_manual(values = cbPalette) +
    labs(color = "Population")
  
  p_legend <- cowplot::get_legend(p1)
  
  p1 <- p1 + guides(colour="none")
  
  p2 <- df %>%
    ggplot(aes(x = Beagle, y = SHAPEIT, color = pop)) +
    geom_point() +
    ggtitle(p_title) +
    theme_classic() +
    geom_abline(slope = 1, intercept = 0) +
    scale_color_manual(values = cbPalette) +
    guides(colour="none")
  
  p3 <- df %>%
    ggplot(aes(x = SHAPEIT, y = Eagle, color = pop)) +
    geom_point() +
    theme_classic() +
    geom_abline(slope = 1, intercept = 0) +
    scale_color_manual(values = cbPalette) +
    guides(colour="none")
  
  return(grid.arrange(p2, p_legend, p1, p3, ncol = 2))
  }
df_vcftools %>%
  mutate(Beagle = n_other_beagle + n_flip_beagle,
         Eagle = n_other_eagle + n_flip_eagle, 
         SHAPEIT = n_other_shapeit + n_flip_shapeit) %>%
  cross_meth_plot(p_title = "Total Errors")
```

#### Error rates (per heterozygous site)

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) / n_hets,
         Eagle = (n_other_eagle + n_flip_eagle) / n_hets, 
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets) %>%
  ggplot(aes(x = Beagle, y = Eagle, color = pop)) +
  geom_point() +
  ggtitle("Total Errors per Heterozygous Site") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) / n_hets,
         Eagle = (n_other_eagle + n_flip_eagle) / n_hets, 
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets) %>%
  ggplot(aes(x = Beagle, y = SHAPEIT, color = pop)) +
  geom_point() +
  ggtitle("Total Errors per Heterozygous Site") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) / n_hets,
         Eagle = (n_other_eagle + n_flip_eagle) / n_hets, 
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets) %>%
  ggplot(aes(x = Eagle, y = SHAPEIT, color = pop)) +
  geom_point() +
  ggtitle("Total Errors per Heterozygous Site") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

All in one figure:

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) / n_hets,
         Eagle = (n_other_eagle + n_flip_eagle) / n_hets, 
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets) %>%
  cross_meth_plot(p_title = "Total Error Rates")
```


### Non-flip switches

```{r include=FALSE}
s_l_b <- df_vcftools %>%
  mutate(Beagle = (n_other_beagle),
         Eagle = (n_other_eagle ), 
         SHAPEIT = (n_other_shapeit)) %>%
  mutate(s_l_b = SHAPEIT < Beagle) %>%
  pull(s_l_b) %>%
  sum()

s_l_e<- df_vcftools %>%
  mutate(Beagle = (n_other_beagle),
         Eagle = (n_other_eagle ), 
         SHAPEIT = (n_other_shapeit)) %>%
  mutate(s_l_e = SHAPEIT < Eagle) %>%
  pull(s_l_e) %>%
  sum()

b_l_e<- df_vcftools %>%
  mutate(Beagle = (n_other_beagle),
         Eagle = (n_other_eagle ), 
         SHAPEIT = (n_other_shapeit)) %>%
  mutate(b_l_e = Beagle < Eagle) %>%
  pull(b_l_e) %>%
  sum()
```

For switches, we observe fewer errors in SHAPEIT than in Beagle in `r s_l_b` synthetic diploids, and in `r s_l_e` synthetic diploids we observe fewer errors in SHAPEIT than in Eagle. Comparing Beagle to Eagle, we observe fewer errors in Beagle than in Eagle in `r b_l_e` synthetic diploids.

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle),
         Eagle = (n_other_eagle ), 
         SHAPEIT = (n_other_shapeit)) %>%
  ggplot(aes(x = Beagle, y = Eagle, color = pop)) +
  geom_point() +
  ggtitle("Switches") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
   mutate(Beagle = (n_other_beagle),
         Eagle = (n_other_eagle ), 
         SHAPEIT = (n_other_shapeit)) %>%
  ggplot(aes(x = Beagle, y = SHAPEIT, color = pop)) +
  geom_point() +
  ggtitle("Switches") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
   mutate(Beagle = (n_other_beagle),
         Eagle = (n_other_eagle ), 
         SHAPEIT = (n_other_shapeit)) %>%
  ggplot(aes(x = Eagle, y = SHAPEIT, color = pop)) +
  geom_point() +
  ggtitle("Switches") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
   mutate(Beagle = (n_other_beagle),
         Eagle = (n_other_eagle ), 
         SHAPEIT = (n_other_shapeit)) %>%
  cross_meth_plot(p_title = "Switches")
```


#### Per het. site

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle) / n_hets,
         Eagle = (n_other_eagle ) / n_hets, 
         SHAPEIT = (n_other_shapeit) / n_hets) %>%
  ggplot(aes(x = Beagle, y = Eagle, color = pop)) +
  geom_point() +
  ggtitle("Switches per Heterozygous Site") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle) / n_hets,
         Eagle = (n_other_eagle ) / n_hets, 
         SHAPEIT = (n_other_shapeit) / n_hets) %>%
  ggplot(aes(x = Beagle, y = SHAPEIT, color = pop)) +
  geom_point() +
  ggtitle("Switches per Heterozygous Site") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle) / n_hets,
         Eagle = (n_other_eagle ) / n_hets, 
         SHAPEIT = (n_other_shapeit) / n_hets) %>%
  ggplot(aes(x = Eagle, y = SHAPEIT, color = pop)) +
  geom_point() +
  ggtitle("Switches per Heterozygous Site") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_beagle) / n_hets,
         Eagle = (n_other_eagle ) / n_hets, 
         SHAPEIT = (n_other_shapeit) / n_hets) %>%
  cross_meth_plot(p_title = "Switch Rate")
```


### Flips

```{r include=FALSE}
b_l_s <- df_vcftools %>%
  mutate(Beagle = (n_flip_beagle),
         Eagle = (n_flip_eagle ), 
         SHAPEIT = (n_flip_shapeit)) %>%
  mutate(b_l_s = SHAPEIT > Beagle) %>%
  pull(b_l_s) %>%
  sum()

e_l_s<- df_vcftools %>%
  mutate(Beagle = (n_flip_beagle),
         Eagle = (n_flip_eagle ), 
         SHAPEIT = (n_flip_shapeit)) %>%
  mutate(e_l_s = SHAPEIT > Eagle) %>%
  pull(e_l_s) %>%
  sum()

e_l_b<- df_vcftools %>%
  mutate(Beagle = (n_flip_beagle),
         Eagle = (n_flip_eagle ), 
         SHAPEIT = (n_flip_shapeit)) %>%
  mutate(e_l_b = Beagle > Eagle) %>%
  pull(e_l_b) %>%
  sum()
```

For switches, we observe fewer errors in Beagle than in SHAPEIT in `r b_l_s` synthetic diploids, and in `r e_l_s` synthetic diploids we observe fewer errors in Eagle than in SHAPEIT Comparing Beagle to Eagle, we observe fewer errors in Eagle than in Beagle in `r e_l_b` synthetic diploids.

```{r}
df_vcftools %>%
  mutate(Beagle = (n_flip_beagle),
         Eagle = (n_flip_eagle ), 
         SHAPEIT = (n_flip_shapeit)) %>%
  ggplot(aes(x = Beagle, y = Eagle, color = pop)) +
  geom_point() +
  ggtitle("Flips") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
   mutate(Beagle = (n_flip_beagle),
         Eagle = (n_flip_eagle ), 
         SHAPEIT = (n_flip_shapeit)) %>%
  ggplot(aes(x = Beagle, y = SHAPEIT, color = pop)) +
  geom_point() +
  ggtitle("Flips") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
   mutate(Beagle = (n_flip_beagle),
         Eagle = (n_flip_eagle ), 
         SHAPEIT = (n_flip_shapeit)) %>%
  ggplot(aes(x = Eagle, y = SHAPEIT, color = pop)) +
  geom_point() +
  ggtitle("Flips") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
  mutate(Beagle = (n_flip_beagle),
         Eagle = (n_flip_eagle ), 
         SHAPEIT = (n_flip_shapeit))  %>%
  cross_meth_plot(p_title = "Flip Errors")
```

#### Per het. site

```{r}
df_vcftools %>%
  mutate(Beagle = (n_flip_beagle) / n_hets,
         Eagle = (n_flip_eagle ) / n_hets, 
         SHAPEIT = (n_flip_shapeit) / n_hets) %>%
  ggplot(aes(x = Beagle, y = Eagle, color = pop)) +
  geom_point() +
  ggtitle("Flips per Heterozygous Site") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
  mutate(Beagle = (n_flip_beagle) / n_hets,
         Eagle = (n_flip_eagle ) / n_hets, 
         SHAPEIT = (n_flip_shapeit) / n_hets) %>%
  ggplot(aes(x = Beagle, y = SHAPEIT, color = pop)) +
  geom_point() +
  ggtitle("Flips per Heterozygous Site") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
  mutate(Beagle = (n_flip_beagle) / n_hets,
         Eagle = (n_flip_eagle ) / n_hets, 
         SHAPEIT = (n_flip_shapeit) / n_hets) %>%
  ggplot(aes(x = Eagle, y = SHAPEIT, color = pop)) +
  geom_point() +
  ggtitle("Flips per Heterozygous Site") +
  theme_classic() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = cbPalette)
```

```{r}
df_vcftools %>%
  mutate(Beagle = (n_flip_beagle) / n_hets,
         Eagle = (n_flip_eagle ) / n_hets, 
         SHAPEIT = (n_flip_shapeit) / n_hets) %>%
  cross_meth_plot(p_title = "Flip Error Rates")
```


### Proportion of errors at CpG

```{r}
df_vcftools %>%
  mutate(Beagle = (n_switch_cpg_beagle / n_switch_beagle),
         Eagle = (n_switch_cpg_eagle / n_switch_eagle),
         SHAPEIT = (n_switch_cpg_shapeit / n_switch_shapeit)) %>%
  select(Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(everything(), names_to = "method", values_to = "enrich") %>%
  ggplot(aes(x = method, y = enrich)) +
  geom_boxplot() +
  ggtitle("Errors at CpG Sites") +
  xlab("Method") +
  ylab("Proportion") +
  theme_classic()

df_vcftools %>%
  mutate(Beagle = (n_other_cpg_beagle / n_other_beagle),
         Eagle = (n_other_cpg_eagle / n_other_eagle),
         SHAPEIT = (n_other_cpg_shapeit / n_other_shapeit)) %>%
  select(Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(everything(), names_to = "method", values_to = "enrich") %>%
  ggplot(aes(x = method, y = enrich)) +
  geom_boxplot() +
  ggtitle("Switches at CpG Sites") +
  xlab("Method") +
  ylab("Proportion") +
  theme_classic()

df_vcftools %>%
  mutate(Beagle = (n_flip_cpg_beagle / n_flip_beagle),
         Eagle = (n_flip_cpg_eagle / n_flip_eagle),
         SHAPEIT = (n_flip_cpg_shapeit / n_flip_shapeit)) %>%
  select(Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(everything(), names_to = "method", values_to = "enrich") %>%
  ggplot(aes(x = method, y = enrich)) +
  geom_boxplot() +
  ggtitle("Flips at CpG Sites") +
  xlab("Method") +
  ylab("Proportion") +
  theme_classic()

df_vcftools %>%
  mutate(Beagle = (n_switch_cpg_beagle / n_switch_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_switch_cpg_eagle / n_switch_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_switch_cpg_shapeit / n_switch_shapeit) / (n_het_cpg / n_hets)) %>%
  select(Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(everything(), names_to = "method", values_to = "enrich") %>%
  ggplot(aes(x = method, y = enrich)) +
  geom_boxplot() +
  ggtitle("Enrichment of Errors at CpG Sites") +
  xlab("Method") +
  ylab("Enrichment") +
  theme_classic() +
  geom_hline(yintercept = 1)

df_vcftools %>%
  mutate(Beagle = (n_other_cpg_beagle / n_other_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_other_cpg_eagle / n_other_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_other_cpg_shapeit / n_other_shapeit) / (n_het_cpg / n_hets)) %>%
  select(Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(everything(), names_to = "method", values_to = "enrich") %>%
  ggplot(aes(x = method, y = enrich)) +
  geom_boxplot() +
  ggtitle("Enrichment of Switches at CpG Sites") +
  xlab("Method") +
  ylab("Enrichment") +
  theme_classic() +
  geom_hline(yintercept = 1)

df_vcftools %>%
  mutate(Beagle = (n_flip_cpg_beagle / n_flip_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_flip_cpg_eagle / n_flip_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_flip_cpg_shapeit / n_flip_shapeit) / (n_het_cpg / n_hets)) %>%
  select(Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(everything(), names_to = "method", values_to = "enrich") %>%
  ggplot(aes(x = method, y = enrich)) +
  geom_boxplot() +
  ggtitle("Enrichment of Flips at CpG Sites") +
  xlab("Method") +
  ylab("Enrichment") +
  theme_classic() +
  geom_hline(yintercept = 1)

df_vcftools %>%
  mutate(Beagle = (n_switch_cpg_beagle / n_switch_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_switch_cpg_eagle / n_switch_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_switch_cpg_shapeit / n_switch_shapeit) / (n_het_cpg / n_hets)) %>%
  select(pop, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(-pop, names_to = "method", values_to = "enrich") %>%
  ggplot(aes(x = method, y = enrich, colour = pop)) +
  geom_boxplot() +
  ggtitle("Enrichment of Errors at CpG Sites") +
  xlab("Method") +
  ylab("Enrichment") +
  theme_classic() +
  geom_hline(yintercept = 1) +
  scale_color_manual(values=cbPalette) +
  labs(color = "Population")

df_vcftools %>%
  mutate(Beagle = (n_other_cpg_beagle / n_other_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_other_cpg_eagle / n_other_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_other_cpg_shapeit / n_other_shapeit) / (n_het_cpg / n_hets)) %>%
  select(pop, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(-pop, names_to = "method", values_to = "enrich") %>%
  ggplot(aes(x = method, y = enrich, colour = pop)) +
  geom_boxplot() +
  ggtitle("Enrichment of Switches at CpG Sites") +
  xlab("Method") +
  ylab("Enrichment") +
  theme_classic() +
  geom_hline(yintercept = 1) +
  scale_color_manual(values=cbPalette) +
  labs(color = "Population")

df_vcftools %>%
  mutate(Beagle = (n_flip_cpg_beagle / n_flip_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_flip_cpg_eagle / n_flip_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_flip_cpg_shapeit / n_flip_shapeit) / (n_het_cpg / n_hets)) %>%
  select(pop, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(-pop, names_to = "method", values_to = "enrich") %>%
  ggplot(aes(x = method, y = enrich, color = pop)) +
  geom_boxplot() +
  ggtitle("Enrichment of Flips at CpG Sites") +
  xlab("Method") +
  ylab("Enrichment") +
  theme_classic() +
  geom_hline(yintercept = 1) +
  scale_color_manual(values=cbPalette) +
  labs(color = "Population")
```

We observe a mild enrichment of switches and a more profound enrichment of flips at CpGs across all methods. We also observe some variation across populations within each method, for example: AFR has almost no enrichment for switches in both Beagle and SHAPEIT.

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_cpg_beagle / n_other_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_other_cpg_eagle / n_other_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_other_cpg_shapeit / n_other_shapeit) / (n_het_cpg / n_hets)) %>%
  cross_meth_plot(p_title = "CpG Enrichment: Switches")

df_vcftools %>%
  mutate(Beagle = (n_flip_cpg_beagle / n_flip_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_flip_cpg_eagle / n_flip_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_flip_cpg_shapeit / n_flip_shapeit) / (n_het_cpg / n_hets)) %>%
  cross_meth_plot(p_title = "CpG Enrichment: Flips")
```

#### Tables

##### Total errors

```{r}
df_vcftools %>%
  mutate(Beagle = (n_switch_cpg_beagle / n_switch_beagle),
         Eagle = (n_switch_cpg_eagle / n_switch_eagle),
         SHAPEIT = (n_switch_cpg_shapeit / n_switch_shapeit)) %>%
  tbl_summary(include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

df_vcftools %>%
  mutate(Beagle = (n_switch_cpg_beagle / n_switch_beagle),
         Eagle = (n_switch_cpg_eagle / n_switch_eagle),
         SHAPEIT = (n_switch_cpg_shapeit / n_switch_shapeit)) %>%
  tbl_summary(by = pop,
              include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

df_vcftools %>%
  mutate(Beagle = (n_switch_cpg_beagle / n_switch_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_switch_cpg_eagle / n_switch_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_switch_cpg_shapeit / n_switch_shapeit) / (n_het_cpg / n_hets)) %>%
  tbl_summary(include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

df_vcftools %>%
  mutate(Beagle = (n_switch_cpg_beagle / n_switch_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_switch_cpg_eagle / n_switch_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_switch_cpg_shapeit / n_switch_shapeit) / (n_het_cpg / n_hets)) %>%
  tbl_summary(by = pop,
              include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```

##### Switches

```{r}
df_vcftools %>%
  mutate(Beagle = (n_other_cpg_beagle / n_other_beagle),
         Eagle = (n_other_cpg_eagle / n_other_eagle),
         SHAPEIT = (n_other_cpg_shapeit / n_other_shapeit)) %>%
  tbl_summary(include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

df_vcftools %>%
  mutate(Beagle = (n_other_cpg_beagle / n_other_beagle),
         Eagle = (n_other_cpg_eagle / n_other_eagle),
         SHAPEIT = (n_other_cpg_shapeit / n_other_shapeit)) %>%
  tbl_summary(by = pop,
              include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

df_vcftools %>%
  mutate(Beagle = (n_other_cpg_beagle / n_other_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_other_cpg_eagle / n_other_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_other_cpg_shapeit / n_other_shapeit) / (n_het_cpg / n_hets)) %>%
  tbl_summary(include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

df_vcftools %>%
  mutate(Beagle = (n_other_cpg_beagle / n_other_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_other_cpg_eagle / n_other_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_other_cpg_shapeit / n_other_shapeit) / (n_het_cpg / n_hets)) %>%
  tbl_summary(by = pop,
              include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```

##### Flips

```{r}
df_vcftools %>%
  mutate(Beagle = (n_flip_cpg_beagle / n_flip_beagle),
         Eagle = (n_flip_cpg_eagle / n_flip_eagle),
         SHAPEIT = (n_flip_cpg_shapeit / n_flip_shapeit)) %>%
  tbl_summary(include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

df_vcftools %>%
  mutate(Beagle = (n_flip_cpg_beagle / n_flip_beagle),
         Eagle = (n_flip_cpg_eagle / n_flip_eagle),
         SHAPEIT = (n_flip_cpg_shapeit / n_flip_shapeit)) %>%
  tbl_summary(by = pop,
              include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

df_vcftools %>%
  mutate(Beagle = (n_flip_cpg_beagle / n_flip_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_flip_cpg_eagle / n_flip_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_flip_cpg_shapeit / n_flip_shapeit) / (n_het_cpg / n_hets)) %>%
  tbl_summary(include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

df_vcftools %>%
  mutate(Beagle = (n_flip_cpg_beagle / n_flip_beagle) / (n_het_cpg / n_hets),
         Eagle = (n_flip_cpg_eagle / n_flip_eagle) / (n_het_cpg / n_hets),
         SHAPEIT = (n_flip_cpg_shapeit / n_flip_shapeit) / (n_het_cpg / n_hets)) %>%
  tbl_summary(by = pop,
              include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```

## MAF Bins

In the `maf_prop_df` data frame, we have for each synthetic diploid the proportion of heterozygous sites that are: rare variants (maf < 0.01); uncommon variants (0.01 < maf < 0.05); and common variants (maf > 0.05). We also have these proportions for each type of error for each method (switch; flip start; flip end; correct).

Let's first look at the distributions of these proportions for all heterozygous positions within each individual:

```{r}
prop_maf_fig <- function(cat_type, title_text){
  df <- maf_prop_df %>%
    filter(str_detect(category, paste0("^",cat_type, "_[rcu]"))) %>%
    mutate(category = factor(category)) %>%
    mutate(category = fct_recode(category, "Rare" = paste0(cat_type, "_rare"),
                               "Uncommon" = paste0(cat_type, "_uncommon"),
                               "Common" = paste0(cat_type, "_common"))) %>%
    mutate(category = fct_relevel(category, c("Rare", "Uncommon", "Common")))
  
  p <- df %>%
    ggplot(aes(x = category, y = proportion, color = SP)) +
    geom_boxplot() +
    ggtitle(paste0(title_text, " in MAF Bins")) +
    xlab("") +
    ylab("Proportion of Sites") +
    theme_classic() +
    labs(color = "Population") +
    scale_color_manual(values = cbPalette)
  
  tab_prop <- df %>%
    group_by(SP, category) %>%
    summarize(mean_prop = mean(proportion)) %>%
    pivot_wider(id_cols = SP, names_from = category, values_from = mean_prop)
  
  return(list(p = p, tab_prop = tab_prop))
}

res_obj <- prop_maf_fig("het", "Heterozygous Sites")
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### Beagle Errors

#### Switches

```{r}
cat_type <- "beagle_switch"
title_text <- "Beagle Switches"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### Flips

#### Start

```{r}
cat_type <- "beagle_flip"
title_text <- "Beagle Flip Starts"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

#### End

```{r}
cat_type <- "beagle_flip end"
title_text <- "Beagle Flip Ends"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### Eagle Errors

#### Switches

```{r}
cat_type <- "eagle_switch"
title_text <- "Eagle Switches"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### Flips

#### Start

```{r}
cat_type <- "eagle_flip"
title_text <- "Eagle Flips"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

#### End

```{r}
cat_type <- "eagle_flip end"
title_text <- "Eagle Flip Ends"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### SHAPEIT Errors

#### Switches

```{r}
cat_type <- "shapeit_switch"
title_text <- "SHAPEIT Switches"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### Flips

#### Start

```{r}
cat_type <- "shapeit_flip"
title_text <- "SHAPEIT Flips"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

#### End

```{r}
cat_type <- "shapeit_flip end"
title_text <- "SHAPEIT Flip Ends"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### Odds Ratios

Here we'll compoute the ratio of odds of being in the rare variant category for errors and all heterozygous positions within each individual.

```{r}
maf_prop_df %>%
  select(category, proportion, id, SP) %>%
  pivot_wider(names_from = category, values_from = proportion) %>%
  mutate(or_het = het_rare / (1 - het_rare),
         or_b_s = beagle_switch_rare / (1 - beagle_switch_rare),
         or_e_s = eagle_switch_rare / (1 - eagle_switch_rare),
         or_s_s = shapeit_switch_rare / (1 - shapeit_switch_rare)) %>%
  mutate(Beagle = or_b_s / or_het,
         Eagle = or_e_s / or_het,
         SHAPEIT = or_s_s / or_het) %>%
  select(id, SP, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(!id & !SP, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR, colour = SP)) +
  geom_boxplot() +
  ggtitle("Odds Ratio of Rare Variant") +
  ylab("Odds Rare Switch / Odds Rare Heterozygous") +
  theme_classic() +
  labs(colour = "Population") +
  geom_hline(yintercept = 1, linetype = 2)

maf_prop_df %>%
  select(category, proportion, id, SP) %>%
  pivot_wider(names_from = category, values_from = proportion) %>%
  mutate(or_het = het_rare / (1 - het_rare),
         or_b_s = beagle_switch_rare / (1 - beagle_switch_rare),
         or_e_s = eagle_switch_rare / (1 - eagle_switch_rare),
         or_s_s = shapeit_switch_rare / (1 - shapeit_switch_rare)) %>%
  mutate(Beagle = or_b_s / or_het,
         Eagle = or_e_s / or_het,
         SHAPEIT = or_s_s / or_het) %>%
  tbl_summary(include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

maf_prop_df %>%
  select(category, proportion, id, SP) %>%
  pivot_wider(names_from = category, values_from = proportion) %>%
  mutate(or_het = het_rare / (1 - het_rare),
         or_b_s = beagle_switch_rare / (1 - beagle_switch_rare),
         or_e_s = eagle_switch_rare / (1 - eagle_switch_rare),
         or_s_s = shapeit_switch_rare / (1 - shapeit_switch_rare)) %>%
  mutate(Beagle = or_b_s / or_het,
         Eagle = or_e_s / or_het,
         SHAPEIT = or_s_s / or_het) %>%
  tbl_summary(by = SP,
              include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```

```{r}
maf_prop_df %>%
  select(category, proportion, id, SP) %>%
  pivot_wider(names_from = category, values_from = proportion) %>%
  mutate(or_het = het_rare / (1 - het_rare),
         or_b_s = beagle_flip_rare / (1 - beagle_flip_rare),
         or_e_s = eagle_flip_rare / (1 - beagle_flip_rare),
         or_s_s = shapeit_flip_rare / (1 - beagle_flip_rare)) %>%
  mutate(Beagle = or_b_s / or_het,
         Eagle = or_e_s / or_het,
         SHAPEIT = or_s_s / or_het) %>%
  select(id, SP, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(!id & !SP, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR, colour = SP)) +
  geom_boxplot() +
  ggtitle("Odds Ratio of Rare Variant") +
  ylab("Odds Rare Flip / Odds Rare Heterozygous") +
  theme_classic() +
  labs(colour = "Population") +
  geom_hline(yintercept = 1, linetype = 2)

maf_prop_df %>%
  select(category, proportion, id, SP) %>%
  pivot_wider(names_from = category, values_from = proportion) %>%
  mutate(or_het = het_rare / (1 - het_rare),
         or_b_s = beagle_flip_rare / (1 - beagle_flip_rare),
         or_e_s = eagle_flip_rare / (1 - beagle_flip_rare),
         or_s_s = shapeit_flip_rare / (1 - beagle_flip_rare)) %>%
  mutate(Beagle = or_b_s / or_het,
         Eagle = or_e_s / or_het,
         SHAPEIT = or_s_s / or_het) %>%
  tbl_summary(include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )

maf_prop_df %>%
  select(category, proportion, id, SP) %>%
  pivot_wider(names_from = category, values_from = proportion) %>%
  mutate(or_het = het_rare / (1 - het_rare),
         or_b_s = beagle_flip_rare / (1 - beagle_flip_rare),
         or_e_s = eagle_flip_rare / (1 - beagle_flip_rare),
         or_s_s = shapeit_flip_rare / (1 - beagle_flip_rare)) %>%
  mutate(Beagle = or_b_s / or_het,
         Eagle = or_e_s / or_het,
         SHAPEIT = or_s_s / or_het) %>%
  tbl_summary(by = SP,
              include = c(Beagle, Eagle, SHAPEIT),
              statistic = list(
                all_continuous() ~ "{mean} ({sd})",
                all_categorical() ~ "{n} / {N} ({p}%)")
              )
```

