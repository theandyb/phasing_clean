---
title: "trio_phasing_results"
author: "Andy Beck"
date: "2024-05-20"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

Here in this document we present figures, tables, and statistics for the phasing evaluation on the autosomes. This sample consists of 602 individuals phased using a reference panel of unrelated individuals from the 1000 genomes project. The phasing results are compared to a pedigree-adjusted phased genome for each sample.

## Libraries and Data

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(pander)
library(reactable)
library(yaml)
library(gtsummary)

library(grid)
library(gridExtra) 

config_obj <- yaml::read_yaml("_config.yaml")

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

df_subj <- read_csv("data/1kgp/subject_info.csv")
ped_df <- read_table("data/1kgp/1kGP.3202_samples.pedigree_info.txt")

child_ids <- ped_df %>% filter(fatherID != "0" & motherID != "0") %>% pull(sampleID)
unrel_ids <- scan("data/1kgp/unrelated_subjects.txt", what = character())

df_subj_rel <- df_subj %>%
  filter(SAMPLE_NAME %in% child_ids)
df_subj_rel$id2 <- 1:602

df_subj_unrel <- df_subj %>%
  filter(SAMPLE_NAME %in% unrel_ids)

```

### Switch Error Summaries

```{r}
df_switch_trio <- vector(mode = "list", length = 22)


for(i in 1:22){
  df_switch_trio[[i]] <- read_csv(paste0(config_obj$base_dir, "/output/trio_phase_", i, "/switch_errors/summary.csv"),
                                  show_col_types = FALSE)
}

```

### Heterozygous Position Counts

```{r}
# het dfs
df_het <- vector(mode = "list", length = 22)

for(i in 1:22){
  df_het[[i]] <- read_tsv(paste0(config_obj$base_dir, "/output/trio_phase_", i, "/het_pos_count.tsv"),
                   col_names = c("id", "n_het"), 
                   show_col_types = FALSE)
}


```

### deCODE genetic maps (cM/MB)

```{r}
df_decode <- vector(mode = "list", length = 22)

for(i in 1:22){
  df_decode[[i]] <- read_tsv(paste0("data/decode/chr", i, "_recomb.bed"), col_names = c("chr", "start", "end", "cM_MB"), show_col_types = FALSE)
}

```

### Chr X Results

We'll also pull in the results on chromosome X for the synthetic diploids to allow for comparisons of rates between 15 and X.

```{r}
sd_pair_info_df <- read_delim("data/sample_pairs.csv", col_names = c("POP", "ID1", "ID2"))
sd_pair_info_df <- left_join(sd_pair_info_df, df_subj, by = c("ID1"="SAMPLE_NAME")) %>%
  rename(SP = SUPER) %>%
  select(-POPULATION)

df_switch_x <- read_csv(paste0(config_obj$base_dir,"/output/switch_errors/switch_errors/summary.csv"))
df_het_x <- read_tsv(paste0(config_obj$base_dir, "/output/switch_errors/het_pos_count.tsv"), col_names = c("id", "n_het"))
n_var_site_x <- 1722954
df_het_x$frac_het <- df_het_x$n_het / n_var_site_x

sd_pair_info_df$n_het <-df_het_x$n_het
sd_pair_info_df$frac_het <-df_het_x$frac_het

df_decode_x <- read_tsv("data/decode/chrX_recomb.bed", col_names = c("chr", "start", "end", "cM_MB"))
```


## Subject Information

The 1000 Genomes collection of 3,202 genomes is sampled from 26 different populations, each belonging to 1 of 5 distinct super-populations (AFR, AMR, EAS, EUR, SAS). All 26 populations are represented in the 2,504 1kGP phase 3 subjects, but not all are present in the 602 trios sequenced by the New York Genome Center:

```{r}
df_subj %>%
  group_by(SUPER, POPULATION) %>%
  summarize(N = n()) %>%
  reactable( 
            groupBy = c("SUPER"),
            columns = list(
              N = colDef(aggregate = "sum")),
    bordered = TRUE,
    defaultExpanded = TRUE)

df_subj_rel %>%
  group_by(SUPER, POPULATION) %>%
  summarize(N = n()) %>%
  reactable( 
            groupBy = c("SUPER"),
            columns = list(
              N = colDef(aggregate = "sum")),
    bordered = TRUE,
    defaultExpanded = TRUE)

df_subj_unrel %>%
  group_by(SUPER, POPULATION) %>%
  summarize(N = n()) %>%
  reactable( 
            groupBy = c("SUPER"),
            columns = list(
              N = colDef(aggregate = "sum")),
    bordered = TRUE,
    defaultExpanded = TRUE)
```

For completeness, we also tabulate other summary information about the 602 trios (which is just sex; 1 - male, 2 - female):

```{r}
df_subj_rel %>%
  group_by(sex) %>%
  summarize(N = n()) %>%
  reactable( 
            groupBy = c("sex"),
            columns = list(
              N = colDef(aggregate = "sum")),
    bordered = TRUE,
    defaultExpanded = TRUE)

df_subj_unrel %>%
  group_by(sex) %>%
  summarize(N = n()) %>%
  reactable( 
            groupBy = c("sex"),
            columns = list(
              N = colDef(aggregate = "sum")),
    bordered = TRUE,
    defaultExpanded = TRUE)
```

## All Autosome Summaries

### Total Errors

First let's get an overall error rate across all 22 autosomes based on our re-phasing of the trio probands:

```{r}
df_total <- df_switch_trio[[1]] %>%
  mutate(Eagle = (n_other_eagle + n_flip_eagle) / n_hets,
         Beagle = (n_other_beagle + n_flip_beagle) / n_hets,
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets) %>%
  select(Eagle, Beagle, SHAPEIT, SUPER, pair_id) %>%
  mutate(chrom = 1)

for(i in 2:22){
  df_total <- bind_rows(df_total, 
                        {
                          df_switch_trio[[i]] %>%
                            mutate(Eagle = (n_other_eagle + n_flip_eagle) / n_hets,
                                   Beagle = (n_other_beagle + n_flip_beagle) / n_hets,
                                   SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets) %>%
                            select(Eagle, Beagle, SHAPEIT, SUPER, pair_id) %>%
                            mutate(chrom = i)
                        })
}

df_total <- df_total %>%
  bind_rows({df_switch_x %>%
      mutate(Eagle = (n_other_eagle + n_flip_eagle) / n_hets,
                                   Beagle = (n_other_beagle + n_flip_beagle) / n_hets,
                                   SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets) %>%
      rename(SUPER = pop) %>%
                            select(Eagle, Beagle, SHAPEIT, SUPER) %>%
                            mutate(pair_id = 603:1602, chrom = 23)})

df_total %>%
  group_by(chrom) %>%
  summarise(Beagle = mean(Beagle),
            Eagle = mean(Eagle),
            SHAPEIT = mean(SHAPEIT)) %>%
  knitr::kable()

df_total %>%
  group_by(chrom, SUPER) %>%
  summarise(Beagle = mean(Beagle),
            Eagle = mean(Eagle),
            SHAPEIT = mean(SHAPEIT)) %>% 
  knitr::kable()

df_total %>%
  group_by(chrom) %>%
  summarise(Beagle = mean(Beagle),
            Eagle = mean(Eagle),
            SHAPEIT = mean(SHAPEIT)) %>%
  pivot_longer(Beagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
  ggplot(aes(x = chrom, y = error_rate, colour = method, shape = method)) +
  geom_point(size=3) +
  theme_bw() +
  xlab("Chromosome") +
  ylab("Error Rate") +
  labs(colour = "Method", shape = "Method") +
  scale_colour_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous("Chromosome", labels = as.character(unique(df_total$chrom)), breaks = unique(df_total$chrom))

df_total %>%
  group_by(chrom, SUPER) %>%
  summarise(Beagle = mean(Beagle),
            Eagle = mean(Eagle),
            SHAPEIT = mean(SHAPEIT)) %>%
  pivot_longer(Beagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
  ggplot(aes(x = chrom, y = error_rate, colour = SUPER, shape = method)) +
  geom_point(size=2) +
  theme_bw() +
  ylab("Error Rate") +
  xlab("Chromosome") +
  labs(colour = "Population", shape = "Method") +
  scale_colour_brewer(palette = "Set1")
```

For each chromosome, we will test several hypotheses:

1. Are the error rates for Beagle, Eagle, and SHAPEIT the same?
2. If the above does not hold, when we do pairwise comparisons between the methods, are error rates the same?
3. Do error rates differ by population? If so, do above tests separately for each population.

For the first test, I'll use a linear mixed model with random intercepts for each individual/synthetic diploid. This will also allow me to do contrasts for the pairwise comparisons.

```{r}
mod_fit <- df_total %>%
  filter(chrom == 1) %>%
  pivot_longer(Eagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
  {lmerTest::lmer(error_rate ~ method + (1|pair_id), data = .)}

df_anova <- anova(mod_fit) %>% broom::tidy() %>% mutate(chrom = 1)

df_pairwise <- emmeans::emmeans(mod_fit, ~ method) %>% pairs() %>% broom::tidy() %>% mutate(chrom=1)

for(i in 2:23){
  mod_fit <- df_total %>%
    filter(chrom == i) %>%
    pivot_longer(Eagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
    {lmerTest::lmer(error_rate ~ method + (1|pair_id), data = .)}
  
  df_anova <- df_anova %>% bind_rows({anova(mod_fit) %>% broom::tidy() %>% mutate(chrom = i)})
  df_pairwise <- df_pairwise %>% bind_rows({
    emmeans::emmeans(mod_fit, ~ method) %>% pairs() %>% broom::tidy() %>% mutate(chrom=i)})
}

df_anova %>% knitr::kable()

df_pairwise %>% knitr::kable()
```

Now let's do these comparisons within each super-population:

```{r}
mod_fit <- df_total %>%
  filter(chrom == 1) %>%
  pivot_longer(Eagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
  {lmerTest::lmer(error_rate ~ method*SUPER + (1|pair_id), data = .)}

df_pop_anova <- anova(mod_fit) %>% broom::tidy() %>% mutate(chrom = 1)

df_pop_pairwise <- emmeans::emmeans(mod_fit, ~ method | SUPER) %>% pairs() %>% broom::tidy() %>% mutate(chrom=1)
df_pop_pop <- emmeans::emmeans(mod_fit, ~ SUPER | method) %>% pairs() %>% broom::tidy() %>% mutate(chrom = 1)

for(i in 2:23){
  mod_fit <- df_total %>%
    filter(chrom == i) %>%
    pivot_longer(Eagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
    {lmerTest::lmer(error_rate ~ method*SUPER + (1|pair_id), data = .)}
  
  df_pop_anova <- df_pop_anova %>% bind_rows({anova(mod_fit) %>% broom::tidy() %>% mutate(chrom = i)})
  df_pop_pairwise <- df_pop_pairwise %>% bind_rows({
    emmeans::emmeans(mod_fit, ~ method | SUPER) %>% pairs() %>% broom::tidy() %>% mutate(chrom=i)})
  df_pop_pop <- df_pop_pop %>% bind_rows({
    emmeans::emmeans(mod_fit, ~ SUPER | method) %>% pairs() %>% broom::tidy() %>% mutate(chrom = i)})
}

df_pop_anova %>% knitr::kable()
df_pop_pairwise %>% knitr::kable()
df_pop_pop %>% knitr::kable()
```

### Switch Errors

Next, let's consider switches and flips independently:

```{r}
df_switches <- df_switch_trio[[1]] %>%
  mutate(Eagle = (n_other_eagle) / n_hets,
         Beagle = (n_other_beagle) / n_hets,
         SHAPEIT = (n_other_shapeit) / n_hets) %>%
  select(Eagle, Beagle, SHAPEIT, SUPER, pair_id) %>%
  mutate(chrom = 1)

for(i in 2:22){
  df_switches <- bind_rows(df_switches, 
                        {
                          df_switch_trio[[i]] %>%
                            mutate(Eagle = (n_other_eagle) / n_hets,
                                   Beagle = (n_other_beagle) / n_hets,
                                   SHAPEIT = (n_other_shapeit) / n_hets) %>%
                            select(Eagle, Beagle, SHAPEIT, SUPER, pair_id) %>%
                            mutate(chrom = i)
                        })
}

df_switches <- df_switches %>%
  bind_rows({df_switch_x %>%
      mutate(Eagle = (n_other_eagle) / n_hets,
                                   Beagle = (n_other_beagle) / n_hets,
                                   SHAPEIT = (n_other_shapeit) / n_hets) %>%
      rename(SUPER = pop) %>%
                            select(Eagle, Beagle, SHAPEIT, SUPER) %>%
                            mutate(pair_id = 603:1602, chrom = 23)})

df_switches %>%
  group_by(chrom) %>%
  summarise(Beagle = mean(Beagle),
            Eagle = mean(Eagle),
            SHAPEIT = mean(SHAPEIT)) %>%
  knitr::kable()

df_switches %>%
  group_by(chrom, SUPER) %>%
  summarise(Beagle = mean(Beagle),
            Eagle = mean(Eagle),
            SHAPEIT = mean(SHAPEIT)) %>%  
  knitr::kable() 

df_switches %>%
  group_by(chrom) %>%
  summarise(Beagle = mean(Beagle),
            Eagle = mean(Eagle),
            SHAPEIT = mean(SHAPEIT)) %>%
  pivot_longer(Beagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
  ggplot(aes(x = chrom, y = error_rate, colour = method, shape = method)) +
  geom_point(size=3) +
  theme_bw() +
  xlab("Chromosome") +
  ylab("Switch Rate") +
  labs(colour = "Method", shape = "Method") +
  scale_colour_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous("Chromosome", labels = as.character(unique(df_switches$chrom)), breaks = unique(df_switches$chrom))

df_switches %>%
  group_by(chrom, SUPER) %>%
  summarise(Beagle = mean(Beagle),
            Eagle = mean(Eagle),
            SHAPEIT = mean(SHAPEIT)) %>%
  pivot_longer(Beagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
  ggplot(aes(x = chrom, y = error_rate, colour = SUPER, shape = method)) +
  geom_point(size=2) +
  theme_bw() +
  ylab("Switch Rate") +
  xlab("Chromosome") +
  labs(colour = "Population", shape = "Method") +
  scale_colour_brewer(palette = "Set1") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous("Chromosome", labels = as.character(unique(df_switches$chrom)), breaks = unique(df_switches$chrom))
```

```{r}
mod_fit <- df_switches %>%
  filter(chrom == 1) %>%
  pivot_longer(Eagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
  {lmerTest::lmer(error_rate ~ method + (1|pair_id), data = .)}

df_anova <- anova(mod_fit) %>% broom::tidy() %>% mutate(chrom = 1)

df_pairwise <- emmeans::emmeans(mod_fit, ~ method) %>% pairs() %>% broom::tidy() %>% mutate(chrom=1)

for(i in 2:23){
  mod_fit <- df_switches %>%
    filter(chrom == i) %>%
    pivot_longer(Eagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
    {lmerTest::lmer(error_rate ~ method + (1|pair_id), data = .)}
  
  df_anova <- df_anova %>% bind_rows({anova(mod_fit) %>% broom::tidy() %>% mutate(chrom = i)})
  df_pairwise <- df_pairwise %>% bind_rows({
    emmeans::emmeans(mod_fit, ~ method) %>% pairs() %>% broom::tidy() %>% mutate(chrom=i)})
}

df_anova %>% knitr::kable()

df_pairwise %>% knitr::kable()
```

Now let's do these comparisons within each super-population:

```{r}
mod_fit <- df_switches %>%
  filter(chrom == 1) %>%
  pivot_longer(Eagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
  {lmerTest::lmer(error_rate ~ method*SUPER + (1|pair_id), data = .)}

df_pop_anova <- anova(mod_fit) %>% broom::tidy() %>% mutate(chrom = 1)

df_pop_pairwise <- emmeans::emmeans(mod_fit, ~ method | SUPER) %>% pairs() %>% broom::tidy() %>% mutate(chrom=1)
df_pop_pop <- emmeans::emmeans(mod_fit, ~ SUPER | method) %>% pairs() %>% broom::tidy() %>% mutate(chrom = 1)

for(i in 2:23){
  mod_fit <- df_switches %>%
    filter(chrom == i) %>%
    pivot_longer(Eagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
    {lmerTest::lmer(error_rate ~ method*SUPER + (1|pair_id), data = .)}
  
  df_pop_anova <- df_pop_anova %>% bind_rows({anova(mod_fit) %>% broom::tidy() %>% mutate(chrom = i)})
  df_pop_pairwise <- df_pop_pairwise %>% bind_rows({
    emmeans::emmeans(mod_fit, ~ method | SUPER) %>% pairs() %>% broom::tidy() %>% mutate(chrom=i)})
  df_pop_pop <- df_pop_pop %>% bind_rows({
    emmeans::emmeans(mod_fit, ~ SUPER | method) %>% pairs() %>% broom::tidy() %>% mutate(chrom = i)})
}

df_pop_anova %>% 
  knitr::kable()
df_pop_pairwise %>% knitr::kable()

df_pop_pop %>% knitr::kable()
```

### Flip Errors

```{r}
df_flips <- df_switch_trio[[1]] %>%
  mutate(Eagle = (n_flip_eagle) / n_hets,
         Beagle = (n_flip_beagle) / n_hets,
         SHAPEIT = (n_flip_shapeit) / n_hets) %>%
  select(Eagle, Beagle, SHAPEIT, SUPER, pair_id) %>%
  mutate(chrom = 1)

for(i in 2:22){
  df_flips <- bind_rows(df_flips, 
                        {
                          df_switch_trio[[i]] %>%
                            mutate(Eagle = (n_flip_eagle) / n_hets,
                                   Beagle = (n_flip_beagle) / n_hets,
                                   SHAPEIT = (n_flip_shapeit) / n_hets) %>%
                            select(Eagle, Beagle, SHAPEIT, SUPER, pair_id) %>%
                            mutate(chrom = i)
                        })
}

df_flips <- df_flips %>%
  bind_rows({df_switch_x %>%
      mutate(Eagle = (n_flip_eagle) / n_hets,
             Beagle = (n_flip_beagle) / n_hets,
             SHAPEIT = (n_flip_shapeit) / n_hets) %>%
      rename(SUPER = pop) %>%
                            select(Eagle, Beagle, SHAPEIT, SUPER) %>%
                            mutate(pair_id = 603:1602, chrom = 23)})

df_flips %>%
  group_by(chrom) %>%
  summarise(Beagle = mean(Beagle),
            Eagle = mean(Eagle),
            SHAPEIT = mean(SHAPEIT)) %>% 
  knitr::kable()

df_flips %>%
  group_by(chrom, SUPER) %>%
  summarise(Beagle = mean(Beagle),
            Eagle = mean(Eagle),
            SHAPEIT = mean(SHAPEIT)) %>% 
  knitr::kable() 

df_flips %>%
  group_by(chrom) %>%
  summarise(Beagle = mean(Beagle),
            Eagle = mean(Eagle),
            SHAPEIT = mean(SHAPEIT)) %>%
  pivot_longer(Beagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
  ggplot(aes(x = chrom, y = error_rate, colour = method, shape = method)) +
  geom_point(size=3) +
  theme_bw() +
  xlab("Chromosome") +
  ylab("Flip Rate") +
  labs(colour = "Method", shape = "Method") +
  scale_colour_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous("Chromosome", labels = as.character(unique(df_flips$chrom)), breaks = unique(df_flips$chrom))

df_flips %>%
  group_by(chrom, SUPER) %>%
  summarise(Beagle = mean(Beagle),
            Eagle = mean(Eagle),
            SHAPEIT = mean(SHAPEIT)) %>%
  pivot_longer(Beagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
  ggplot(aes(x = chrom, y = error_rate, colour = SUPER, shape = method)) +
  geom_point(size=2) +
  theme_bw() +
  ylab("Switch Rate") +
  xlab("Chromosome") +
  labs(colour = "Population", shape = "Method") +
  scale_colour_brewer(palette = "Set1") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous("Chromosome", labels = as.character(unique(df_flips$chrom)), breaks = unique(df_flips$chrom))
```

```{r}
mod_fit <- df_flips %>%
  filter(chrom == 1) %>%
  pivot_longer(Eagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
  {lmerTest::lmer(error_rate ~ method + (1|pair_id), data = .)}

df_anova <- anova(mod_fit) %>% broom::tidy() %>% mutate(chrom = 1)

df_pairwise <- emmeans::emmeans(mod_fit, ~ method) %>% pairs() %>% broom::tidy() %>% mutate(chrom=1)

for(i in 2:23){
  mod_fit <- df_flips %>%
    filter(chrom == i) %>%
    pivot_longer(Eagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
    {lmerTest::lmer(error_rate ~ method + (1|pair_id), data = .)}
  
  df_anova <- df_anova %>% bind_rows({anova(mod_fit) %>% broom::tidy() %>% mutate(chrom = i)})
  df_pairwise <- df_pairwise %>% bind_rows({
    emmeans::emmeans(mod_fit, ~ method) %>% pairs() %>% broom::tidy() %>% mutate(chrom=i)})
}

df_anova %>%
  knitr::kable()

df_pairwise %>%
  knitr::kable()
```

```{r}
mod_fit <- df_flips %>%
  filter(chrom == 1) %>%
  pivot_longer(Eagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
  {lmerTest::lmer(error_rate ~ method*SUPER + (1|pair_id), data = .)}

df_pop_anova <- anova(mod_fit) %>% broom::tidy() %>% mutate(chrom = 1)

df_pop_pairwise <- emmeans::emmeans(mod_fit, ~ method | SUPER) %>% pairs() %>% broom::tidy() %>% mutate(chrom=1)
df_pop_pop <- emmeans::emmeans(mod_fit, ~ SUPER | method) %>% pairs() %>% broom::tidy() %>% mutate(chrom = 1)

for(i in 2:23){
  mod_fit <- df_flips %>%
    filter(chrom == i) %>%
    pivot_longer(Eagle:SHAPEIT, names_to = "method", values_to = "error_rate") %>%
    {lmerTest::lmer(error_rate ~ method*SUPER + (1|pair_id), data = .)}
  
  df_pop_anova <- df_pop_anova %>% bind_rows({anova(mod_fit) %>% broom::tidy() %>% mutate(chrom = i)})
  df_pop_pairwise <- df_pop_pairwise %>% bind_rows({
    emmeans::emmeans(mod_fit, ~ method | SUPER) %>% pairs() %>% broom::tidy() %>% mutate(chrom=i)})
  df_pop_pop <- df_pop_pop %>% bind_rows({
    emmeans::emmeans(mod_fit, ~ SUPER | method) %>% pairs() %>% broom::tidy() %>% mutate(chrom = i)})
}

df_pop_anova %>%
  knitr::kable()
df_pop_pairwise %>% knitr::kable()

df_pop_pop %>% knitr::kable()
```

## Switch Errors

### Total Errors

```{r}
cross_meth_plot <- function(df, p_title, p_func, pop, chrom="15") {
  p1 <- p_func(df, "Beagle", "SHAPEIT", pop, chrom = chrom)
  p_legend <- cowplot::get_legend(p1)
  
  p1 <- p1 + guides(colour="none") + ggtitle(p_title, paste0("Chromosome ", chrom))
  
  p2 <- p_func(df, "Beagle", "Eagle", pop, chrom = chrom) +
    guides(colour="none") + ggtitle("", "")
  
  p3 <- p_func(df, "SHAPEIT", "Eagle", pop, chrom = chrom) +
    guides(colour="none") + ggtitle("", "")
  
  return(grid.arrange(p1, p_legend, p2, p3, ncol = 2))
  }

plot_total_errors <- function(df, m1, m2, pop, chrom="15"){
  p <- df %>%
    mutate(Beagle = (n_other_beagle + n_flip_beagle),
         Eagle =  (n_other_eagle + n_flip_eagle),
         SHAPEIT =  (n_other_shapeit + n_flip_shapeit)) %>%
    ggplot(aes(x = !! sym(m1), y = !! sym(m2), colour = !! sym(pop))) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    ggtitle("Total Errors", paste0("Chromosome ", chrom)) +
    theme_classic() +
    xlab(m1) +
    ylab(m2) +
    labs(color="Population") +
    scale_color_manual(values = cbPalette)
  return(p)
}

table_total_errors <- function(df, pop){
  res <- df %>%
    mutate(Beagle = (n_other_beagle + n_flip_beagle),
         Eagle =  (n_other_eagle + n_flip_eagle),
         SHAPEIT =  (n_other_shapeit + n_flip_shapeit)) %>%
    mutate(b_l_e = factor(Beagle < Eagle),
           b_e_e = factor(Beagle == Eagle),
           b_l_s = factor(Beagle < SHAPEIT),
           e_l_b = factor(Beagle > Eagle),
           e_l_s = factor(Eagle < SHAPEIT),
           s_l_b = factor(SHAPEIT < Beagle),
           s_l_e = factor(SHAPEIT < Eagle)) %>%
    tbl_summary(by = !! sym(pop),  
                include = c(b_l_e, b_e_e, b_l_s, e_l_b, e_l_s, s_l_b, s_l_e))
    
  return(res)
}

plot_total_errors(df_switch_trio[[15]], "Beagle", "Eagle", "SUPER")
plot_total_errors(df_switch_trio[[15]], "Beagle", "SHAPEIT", "SUPER")
plot_total_errors(df_switch_trio[[15]], "SHAPEIT", "Eagle", "SUPER")

cross_meth_plot(df_switch_trio[[15]], "Total Errors", plot_total_errors, "SUPER", "15")

table_total_errors(df_switch_trio[[15]], "SUPER")
```

And now chromosome 22:

```{r}
plot_total_errors(df_switch_trio[[22]], "Beagle", "Eagle", "SUPER", 22)
plot_total_errors(df_switch_trio[[22]], "Beagle", "SHAPEIT", "SUPER", 22)
plot_total_errors(df_switch_trio[[22]], "SHAPEIT", "Eagle", "SUPER", 22)

cross_meth_plot(df_switch_trio[[22]], "Total Errors", plot_total_errors, "SUPER", "22")

table_total_errors(df_switch_trio[[22]], "SUPER")
```


And finally, chromosome X:

```{r}
plot_total_errors(df_switch_x, "Beagle", "Eagle", "pop", "X")
plot_total_errors(df_switch_x, "Beagle", "SHAPEIT", "pop", "X")
plot_total_errors(df_switch_x, "SHAPEIT", "Eagle", "pop", "X")

table_total_errors(df_switch_x, "pop")

cross_meth_plot(df_switch_x, "Total Errors", plot_total_errors, "pop")
```


#### Error Rate

```{r}
plot_total_rate <- function(df, m1, m2, pop, chrom="15"){
  p <- df %>%
    mutate(Beagle = (n_other_beagle + n_flip_beagle) / n_hets,
         Eagle = (n_other_eagle + n_flip_eagle) / n_hets,
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets) %>%
    ggplot(aes(x = !! sym(m1), y = !! sym(m2), colour = !! sym(pop))) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    ggtitle("Error Rate", paste0("Chromosome ", chrom)) +
    theme_classic() +
    xlab(m1) +
    ylab(m2) +
    labs(color="Population") +
    scale_color_manual(values = cbPalette)
  return(p)
}

plot_total_rate(df_switch_trio[[1]], "Beagle", "Eagle", "SUPER")
plot_total_rate(df_switch_trio[[1]], "Beagle", "SHAPEIT", "SUPER")
plot_total_rate(df_switch_trio[[1]], "SHAPEIT", "Eagle", "SUPER")

cross_meth_plot(df_switch_trio[[1]], "Total Errors", plot_total_rate, "SUPER", "15")
```

And now chromosome 22:

```{r}
plot_total_rate(df_switch_trio[[22]], "Beagle", "Eagle", "SUPER", 22)
plot_total_rate(df_switch_trio[[22]], "Beagle", "SHAPEIT", "SUPER", 22)
plot_total_rate(df_switch_trio[[22]], "SHAPEIT", "Eagle", "SUPER", 22)

cross_meth_plot(df_switch_trio[[22]], "Total Errors", plot_total_rate, "SUPER", "22")
```

And now chromosome 1:

```{r}
plot_total_rate(df_switch_trio[[1]], "Beagle", "Eagle", "SUPER", 1)
plot_total_rate(df_switch_trio[[1]], "Beagle", "SHAPEIT", "SUPER", 1)
plot_total_rate(df_switch_trio[[1]], "SHAPEIT", "Eagle", "SUPER", 1)

cross_meth_plot(df_switch_trio[[1]], "Total Errors", plot_total_rate, "SUPER", "1")
```

And finally, chromosome X:

```{r}
plot_total_rate(df_switch_x, "Beagle", "Eagle", "pop", "X")
plot_total_rate(df_switch_x, "Beagle", "SHAPEIT", "pop", "X")
plot_total_rate(df_switch_x, "SHAPEIT", "Eagle", "pop", "X")

cross_meth_plot(df_switch_x, "Total Errors", plot_total_rate, "pop", "X")
```

### Non-flip Switches

```{r}
plot_switches <- function(df, m1, m2, pop, chrom=15){
  p <- df %>%
    mutate(Beagle = n_other_beagle,
         Eagle = n_other_eagle,
         SHAPEIT = n_other_shapeit) %>%
    ggplot(aes(x = !! sym(m1), y = !! sym(m2), colour = !! sym(pop))) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    ggtitle("Switches", paste0("Chromosome ", chrom)) +
    theme_classic() +
    xlab(m1) +
    ylab(m2) +
    labs(color="Population") +
    scale_color_manual(values = cbPalette)
  return(p)
}

table_switches <- function(df, pop){
  res <- df %>%
    mutate(Beagle = (n_other_beagle ),
         Eagle =  (n_other_eagle),
         SHAPEIT =  (n_other_shapeit)) %>%
    mutate(b_l_e = factor(Beagle < Eagle),
           b_l_s = factor(Beagle < SHAPEIT),
           e_l_b = factor(Beagle > Eagle),
           e_l_s = factor(Eagle < SHAPEIT),
           s_l_b = factor(SHAPEIT < Beagle),
           s_l_e = factor(SHAPEIT < Eagle)) %>%
    tbl_summary(by = !! sym(pop),  
                include = c(b_l_e, b_l_s, e_l_b, e_l_s, s_l_b, s_l_e))
    
  return(res)
}

plot_switches(df_switch_trio[[15]], "Beagle", "Eagle", "SUPER")
plot_switches(df_switch_trio[[15]], "Beagle", "SHAPEIT", "SUPER")
plot_switches(df_switch_trio[[15]], "SHAPEIT", "Eagle", "SUPER")

table_switches(df_switch_trio[[15]], "SUPER")

cross_meth_plot(df_switch_trio[[15]], "Switches", plot_switches, "SUPER", "15")
```

And now chromosome 22:

```{r}
plot_switches(df_switch_trio[[22]], "Beagle", "Eagle", "SUPER", 22)
plot_switches(df_switch_trio[[22]], "Beagle", "SHAPEIT", "SUPER", 22)
plot_switches(df_switch_trio[[22]], "SHAPEIT", "Eagle", "SUPER", 22)

table_switches(df_switch_trio[[22]], "SUPER")

cross_meth_plot(df_switch_trio[[2]], "Switches", plot_switches, "SUPER", "22")
```

And now chromosome 1:

```{r}
plot_switches(df_switch_trio[[1]], "Beagle", "Eagle", "SUPER", 1)
plot_switches(df_switch_trio[[1]], "Beagle", "SHAPEIT", "SUPER", 1)
plot_switches(df_switch_trio[[1]], "SHAPEIT", "Eagle", "SUPER", 1)

table_switches(df_switch_trio[[1]], "SUPER")

cross_meth_plot(df_switch_trio[[1]], "Switches", plot_switches, "SUPER", "1")
```

And finally, chromosome X:

```{r}
plot_switches(df_switch_x, "Beagle", "Eagle", "pop", "X")
plot_switches(df_switch_x, "Beagle", "SHAPEIT", "pop", "X")
plot_switches(df_switch_x, "SHAPEIT", "Eagle", "pop", "X")

table_switches(df_switch_x, "pop")

cross_meth_plot(df_switch_x, "Switches", plot_switches, "pop", "X")
```

#### Switch Rate

```{r}
plot_switch_rate <- function(df, m1, m2, pop, chrom = 15){
  p <- df %>%
    mutate(Beagle = n_other_beagle / n_hets,
         Eagle = n_other_eagle / n_hets,
         SHAPEIT = n_other_shapeit / n_hets) %>%
    ggplot(aes(x = !! sym(m1), y = !! sym(m2), colour = !! sym(pop))) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    ggtitle("Switch Rate", paste0("Chromosome ", chrom)) +
    theme_classic() +
    xlab(m1) +
    ylab(m2) +
    labs(color="Population") +
    scale_color_manual(values = cbPalette)
  return(p)
}

plot_switch_rate(df_switch_trio[[15]], "Beagle", "Eagle", "SUPER")
plot_switch_rate(df_switch_trio[[15]], "Beagle", "SHAPEIT", "SUPER")
plot_switch_rate(df_switch_trio[[15]], "SHAPEIT", "Eagle", "SUPER")

cross_meth_plot(df_switch_trio[[15]], "Switches", plot_switch_rate, "SUPER", "15")
```

And now chromosome 22:

```{r}
plot_switch_rate(df_switch_trio[[22]], "Beagle", "Eagle", "SUPER", 22)
plot_switch_rate(df_switch_trio[[22]], "Beagle", "SHAPEIT", "SUPER", 22)
plot_switch_rate(df_switch_trio[[22]], "SHAPEIT", "Eagle", "SUPER", 22)
cross_meth_plot(df_switch_trio[[22]], "Switches", plot_switch_rate, "SUPER", "22")
```

And now chromosome 1:

```{r}
plot_switch_rate(df_switch_trio[[1]], "Beagle", "Eagle", "SUPER", 1)
plot_switch_rate(df_switch_trio[[1]], "Beagle", "SHAPEIT", "SUPER", 1)
plot_switch_rate(df_switch_trio[[1]], "SHAPEIT", "Eagle", "SUPER", 1)
cross_meth_plot(df_switch_trio[[1]], "Switches", plot_switch_rate, "SUPER", "1")
```

And finally, chromosome X:

```{r}
plot_switch_rate(df_switch_x, "Beagle", "Eagle", "pop", "X")
plot_switch_rate(df_switch_x, "Beagle", "SHAPEIT", "pop", "X")
plot_switch_rate(df_switch_x, "SHAPEIT", "Eagle", "pop", "X")

cross_meth_plot(df_switch_x, "Switches", plot_switch_rate, "pop", "X")
```

### Flips

```{r}
plot_flips <- function(df, m1, m2, pop, chrom = 15){
  p <- df %>%
    mutate(Beagle = n_flip_beagle,
         Eagle = n_flip_eagle,
         SHAPEIT = n_flip_shapeit) %>%
    ggplot(aes(x = !! sym(m1), y = !! sym(m2), colour = !! sym(pop))) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    ggtitle("Total Flips", paste0("Chromosome ", chrom)) +
    theme_classic() +
    xlab(m1) +
    ylab(m2) +
    labs(color="Population") +
    scale_color_manual(values = cbPalette)
  return(p)
}

table_flip <- function(df, pop){
  res <- df %>%
    mutate(Beagle = (n_flip_beagle ),
         Eagle =  (n_flip_eagle),
         SHAPEIT =  (n_flip_shapeit)) %>%
    mutate(b_l_e = factor(Beagle < Eagle),
           b_l_s = factor(Beagle < SHAPEIT),
           e_l_b = factor(Beagle > Eagle),
           e_l_s = factor(Eagle < SHAPEIT),
           s_l_b = factor(SHAPEIT < Beagle),
           s_l_e = factor(SHAPEIT < Eagle)) %>%
    tbl_summary(by = !! sym(pop),  
                include = c(b_l_e, b_l_s, e_l_b, e_l_s, s_l_b, s_l_e))
    
  return(res)
}

plot_flips(df_switch_trio[[15]], "Beagle", "Eagle", "SUPER")
plot_flips(df_switch_trio[[15]], "Beagle", "SHAPEIT", "SUPER")
plot_flips(df_switch_trio[[15]], "SHAPEIT", "Eagle", "SUPER")

table_flip(df_switch_trio[[15]], "SUPER")

cross_meth_plot(df_switch_trio[[15]], "Flips", plot_flips, "SUPER", "15")
```

And now chromosome 22:

```{r}
plot_flips(df_switch_trio[[22]], "Beagle", "Eagle", "SUPER", 22)
plot_flips(df_switch_trio[[22]], "Beagle", "SHAPEIT", "SUPER", 22)
plot_flips(df_switch_trio[[22]], "SHAPEIT", "Eagle", "SUPER", 22)

table_flip(df_switch_trio[[22]], "SUPER")

cross_meth_plot(df_switch_trio[[22]], "Flips", plot_flips, "SUPER", "22")
```

And now chromosome 1:

```{r}
plot_flips(df_switch_trio[[1]], "Beagle", "Eagle", "SUPER", 1)
plot_flips(df_switch_trio[[1]], "Beagle", "SHAPEIT", "SUPER", 1)
plot_flips(df_switch_trio[[1]], "SHAPEIT", "Eagle", "SUPER", 1)

table_flip(df_switch_trio[[1]], "SUPER")

cross_meth_plot(df_switch_trio[[1]], "Flips", plot_flips, "SUPER", "1")
```

And finally, chromosome X:

```{r}
plot_flips(df_switch_x, "Beagle", "Eagle", "pop", "X")
plot_flips(df_switch_x, "Beagle", "SHAPEIT", "pop", "X")
plot_flips(df_switch_x, "SHAPEIT", "Eagle", "pop", "X")

table_flip(df_switch_x, "pop")

cross_meth_plot(df_switch_x, "Flips", plot_flips, "pop", "X")
```

#### Flip Rate

```{r}
plot_flip_rate <- function(df, m1, m2, pop, chrom = 15){
  p <- df %>%
    mutate(Beagle = n_flip_beagle / n_hets,
         Eagle = n_flip_eagle / n_hets,
         SHAPEIT = n_flip_shapeit / n_hets) %>%
    ggplot(aes(x = !! sym(m1), y = !! sym(m2), colour = !! sym(pop))) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    ggtitle("Flip rate", paste0("Chromosome ", chrom)) +
    theme_classic() +
    xlab(m1) +
    ylab(m2) +
    labs(color="Population") +
    scale_color_manual(values = cbPalette)
  return(p)
}

plot_flip_rate(df_switch_trio[[15]], "Beagle", "Eagle", "SUPER")
plot_flip_rate(df_switch_trio[[15]], "Beagle", "SHAPEIT", "SUPER")
plot_flip_rate(df_switch_trio[[15]], "SHAPEIT", "Eagle", "SUPER")

cross_meth_plot(df_switch_trio[[15]], "Flips", plot_flip_rate, "SUPER", "15")
```

And now chromosome 22:

```{r}
plot_flip_rate(df_switch_trio[[22]], "Beagle", "Eagle", "SUPER", 22)
plot_flip_rate(df_switch_trio[[22]], "Beagle", "SHAPEIT", "SUPER", 22)
plot_flip_rate(df_switch_trio[[22]], "SHAPEIT", "Eagle", "SUPER", 22)

cross_meth_plot(df_switch_trio[[22]], "Flips", plot_flip_rate, "SUPER", "22")
```

And now chromosome 1:

```{r}
plot_flip_rate(df_switch_trio[[1]], "Beagle", "Eagle", "SUPER", 1)
plot_flip_rate(df_switch_trio[[1]], "Beagle", "SHAPEIT", "SUPER", 1)
plot_flip_rate(df_switch_trio[[1]], "SHAPEIT", "Eagle", "SUPER", 1)

cross_meth_plot(df_switch_trio[[1]], "Flips", plot_flip_rate, "SUPER", "1")
```

And finally, chromosome X:

```{r}
plot_flip_rate(df_switch_x, "Beagle", "Eagle", "pop", "X")
plot_flip_rate(df_switch_x, "Beagle", "SHAPEIT", "pop", "X")
plot_flip_rate(df_switch_x, "SHAPEIT", "Eagle", "pop", "X")

cross_meth_plot(df_switch_x, "Flips", plot_flip_rate, "pop", "X")
```

## Comparisons of Average Rates Across Chromosomes

