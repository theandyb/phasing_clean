---
title: "trio_phasing_results"
author: "Andy Beck"
date: "2024-05-20"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

Here in this document we present figures, tables, and statistics for the phasing evaluation on chromosome 15. This sample consists of 602 individuals phased using a reference panel of unrelated individuals from the 1000 genomes project. The phasing results are compared to a pedigree-adjusted phased genome for each sample.

## Libraries and Data

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(pander)
library(reactable)
library(yaml)
library(gtsummary)

library(grid)
library(gridExtra) 

config_obj <- yaml::read_yaml("_config.yaml")

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

df_subj <- read_csv("data/1kgp/subject_info.csv")
ped_df <- read_table("data/1kgp/1kGP.3202_samples.pedigree_info.txt")

child_ids <- ped_df %>% filter(fatherID != "0" & motherID != "0") %>% pull(sampleID)
unrel_ids <- scan("data/1kgp/unrelated_subjects.txt", what = character())

df_subj_rel <- df_subj %>%
  filter(SAMPLE_NAME %in% child_ids)
df_subj_rel$id2 <- 1:602

df_subj_unrel <- df_subj %>%
  filter(SAMPLE_NAME %in% unrel_ids)

df_switch_trio <- read_csv(paste0(config_obj$base_dir,"/output/trio_phase_15/switch_errors/summary.csv"))

df_switch_trio_22 <- read_csv(paste0(config_obj$base_dir,
                                     "/output/trio_phase_22/switch_errors/summary.csv"))

df_switch_trio_1 <- read_csv(paste0(config_obj$base_dir,
                                     "/output/trio_phase_1/switch_errors/summary.csv"))

# het dfs

df_het <- read_tsv(paste0(config_obj$base_dir, "/output/trio_phase_15/het_pos_count.tsv"),
                   col_names = c("id", "n_het"))
df_het_22 <- read_tsv(paste0(config_obj$base_dir, "/output/trio_phase_22/het_pos_count.tsv"),
                   col_names = c("id", "n_het22"))
df_het_1 <- read_tsv(paste0(config_obj$base_dir, "/output/trio_phase_1/het_pos_count.tsv"),
                   col_names = c("id", "n_het1"))


n_var_site <- 1627002
n_var_site_22 <- 767007
n_var_site_1 <- 4372865

df_het$frac_het <- df_het$n_het / n_var_site
df_het_22$frac_het22 <- df_het_22$n_het22 / n_var_site_22
df_het_1$frac_het1 <- df_het_1$n_het1 / n_var_site_1

df_subj_rel <- left_join(df_subj_rel, df_het, by = c("id2" = "id")) %>%
  left_join(df_het_22, by = c("id2" = "id")) %>%
  left_join(df_het_1, by = c("id2" = "id")) 

df_triple_het <- read_tsv(paste0(config_obj$base_dir, "/output/trio_phase_15/triple_het.tsv"),
                   col_names = c("id", "n_t_het"))
df_triple_het_22 <- read_tsv(paste0(config_obj$base_dir, "/output/trio_phase_22/triple_het.tsv"),
                   col_names = c("id", "n_t_het22"))
df_triple_het_1 <- read_tsv(paste0(config_obj$base_dir, "/output/trio_phase_1/triple_het.tsv"),
                   col_names = c("id", "n_t_het1"))

df_subj_rel <- left_join(df_subj_rel, df_triple_het, by = c("id2" = "id")) %>%
  left_join(df_triple_het_22, by = c("id2" = "id")) %>%
  left_join(df_triple_het_1, by = c("id2" = "id"))

df_subj_rel$frac_t_het <- df_subj_rel$n_t_het / df_subj_rel$n_het
df_subj_rel$frac_t_het1 <- df_subj_rel$n_t_het1 / df_subj_rel$n_het1
df_subj_rel$frac_t_het22 <- df_subj_rel$n_t_het22 / df_subj_rel$n_het22


df_switch_trio <- left_join(df_switch_trio, df_triple_het, by=c("pair_id" = "id"))
df_switch_trio_22 <- left_join(df_switch_trio_22, df_triple_het_22, by=c("pair_id" = "id"))
df_switch_trio_1 <- left_join(df_switch_trio_1, df_triple_het_1, by=c("pair_id" = "id"))

maf_prop_df <- read_csv(paste0(config_obj$base_dir,"/output/trio_phase_15/maf_props.csv"))

maf_prop_df <- left_join(maf_prop_df, 
                         {df_subj_rel %>% 
                             select(id2, POPULATION, SUPER, sex, n_het, n_t_het)},
                         by = c("id" = "id2"))

maf_prop_df_22 <- read_csv(paste0(config_obj$base_dir,"/output/trio_phase_22/maf_props.csv"))

maf_prop_df_22 <- left_join(maf_prop_df_22, 
                         {df_subj_rel %>% 
                             select(id2, POPULATION, SUPER, sex, n_het22, n_t_het22)},
                         by = c("id" = "id2"))

maf_prop_df_1 <- read_csv(paste0(config_obj$base_dir,"/output/trio_phase_1/maf_props.csv"))

maf_prop_df_1 <- left_join(maf_prop_df_1, 
                         {df_subj_rel %>% 
                             select(id2, POPULATION, SUPER, sex, n_het1, n_t_het1)},
                         by = c("id" = "id2"))

### Triple het error counts
#### 15
df_th_b_15 <- read_csv("output/trio_phase_15/switch_errors/beagle_triple_het.csv") %>%
  rename(beagle_switch_th = n_switch_th, beagle_flip_th = n_flip_th)

df_th_e_15 <- read_csv("output/trio_phase_15/switch_errors/eagle_triple_het.csv") %>%
  rename(eagle_switch_th = n_switch_th, eagle_flip_th = n_flip_th)

df_th_s_15 <- read_csv("output/trio_phase_15/switch_errors/shapeit_triple_het.csv") %>%
  rename(shapeit_switch_th = n_switch_th, shapeit_flip_th = n_flip_th)

df_switch_trio <- left_join(df_switch_trio, df_th_b_15, by=c("pair_id" = "id"))
df_switch_trio <- left_join(df_switch_trio, df_th_e_15, by=c("pair_id" = "id"))
df_switch_trio <- left_join(df_switch_trio, df_th_s_15, by=c("pair_id" = "id"))

#### 22
df_th_b_22 <- read_csv("output/trio_phase_22/switch_errors/beagle_triple_het.csv") %>%
  rename(beagle_switch_th22 = n_switch_th, beagle_flip_th22 = n_flip_th)

df_th_e_22 <- read_csv("output/trio_phase_22/switch_errors/eagle_triple_het.csv") %>%
  rename(eagle_switch_th22 = n_switch_th, eagle_flip_th22 = n_flip_th)

df_th_s_22 <- read_csv("output/trio_phase_22/switch_errors/shapeit_triple_het.csv") %>%
  rename(shapeit_switch_th22 = n_switch_th, shapeit_flip_th22 = n_flip_th)

df_switch_trio_22 <- left_join(df_switch_trio_22, df_th_b_22, by=c("pair_id" = "id"))
df_switch_trio_22 <- left_join(df_switch_trio_22, df_th_e_22, by=c("pair_id" = "id"))
df_switch_trio_22 <- left_join(df_switch_trio_22, df_th_s_22, by=c("pair_id" = "id"))

#### 1
df_th_b_1 <- read_csv("output/trio_phase_1/switch_errors/beagle_triple_het.csv") %>%
  rename(beagle_switch_th1 = n_switch_th, beagle_flip_th1 = n_flip_th)

df_th_e_1 <- read_csv("output/trio_phase_1/switch_errors/eagle_triple_het.csv") %>%
  rename(eagle_switch_th1 = n_switch_th, eagle_flip_th1 = n_flip_th)

df_th_s_1 <- read_csv("output/trio_phase_1/switch_errors/shapeit_triple_het.csv") %>%
  rename(shapeit_switch_th1 = n_switch_th, shapeit_flip_th1 = n_flip_th)

df_switch_trio_1 <- left_join(df_switch_trio_1, df_th_b_1, by=c("pair_id" = "id"))
df_switch_trio_1 <- left_join(df_switch_trio_1, df_th_e_1, by=c("pair_id" = "id"))
df_switch_trio_1 <- left_join(df_switch_trio_1, df_th_s_1, by=c("pair_id" = "id"))

# deCODE genetic maps (cM/MB)
df_decode <- read_tsv("data/decode/chr15_recomb.bed", col_names = c("chr", "start", "end", "cM_MB"))
df_decode22 <- read_tsv("data/decode/chr22_recomb.bed", col_names = c("chr", "start", "end", "cM_MB"))
df_decode1 <- read_tsv("data/decode/chr1_recomb.bed", col_names = c("chr", "start", "end", "cM_MB"))
```

### Chr X Results

We'll also pull in the results on chromosome X for the synthetic diploids to allow for comparisons of rates between 15 and X.

```{r}
sd_pair_info_df <- read_delim("data/sample_pairs.csv", col_names = c("POP", "ID1", "ID2"))
sd_pair_info_df <- left_join(sd_pair_info_df, df_subj, by = c("ID1"="SAMPLE_NAME")) %>%
  rename(SP = SUPER) %>%
  select(-POPULATION)

df_switch_x <- read_csv(paste0(config_obj$base_dir,"/output/switch_errors/switch_errors/summary.csv"))
df_het_x <- read_tsv(paste0(config_obj$base_dir, "/output/switch_errors/het_pos_count.tsv"), col_names = c("id", "n_het"))
n_var_site_x <- 1722954
df_het_x$frac_het <- df_het_x$n_het / n_var_site_x

sd_pair_info_df$n_het <-df_het_x$n_het
sd_pair_info_df$frac_het <-df_het_x$frac_het

df_decode_x <- read_tsv("data/decode/chrX_recomb.bed", col_names = c("chr", "start", "end", "cM_MB"))
```


## Subject Information

The 1000 Genomes collection of 3,202 genomes is sampled from 26 different populations, each belonging to 1 of 5 distinct super-populations (AFR, AMR, EAS, EUR, SAS). All 26 populations are represented in the 2,504 1kGP phase 3 subjects, but not all are present in the 602 trios sequenced by the New York Genome Center:

```{r}
df_subj %>%
  group_by(SUPER, POPULATION) %>%
  summarize(N = n()) %>%
  reactable( 
            groupBy = c("SUPER"),
            columns = list(
              N = colDef(aggregate = "sum")),
    bordered = TRUE,
    defaultExpanded = TRUE)

df_subj_rel %>%
  group_by(SUPER, POPULATION) %>%
  summarize(N = n()) %>%
  reactable( 
            groupBy = c("SUPER"),
            columns = list(
              N = colDef(aggregate = "sum")),
    bordered = TRUE,
    defaultExpanded = TRUE)

df_subj_unrel %>%
  group_by(SUPER, POPULATION) %>%
  summarize(N = n()) %>%
  reactable( 
            groupBy = c("SUPER"),
            columns = list(
              N = colDef(aggregate = "sum")),
    bordered = TRUE,
    defaultExpanded = TRUE)
```

For completeness, we also tabulate other summary information about the 602 trios (which is just sex; 1 - male, 2 - female):

```{r}
df_subj_rel %>%
  group_by(sex) %>%
  summarize(N = n()) %>%
  reactable( 
            groupBy = c("sex"),
            columns = list(
              N = colDef(aggregate = "sum")),
    bordered = TRUE,
    defaultExpanded = TRUE)

df_subj_unrel %>%
  group_by(sex) %>%
  summarize(N = n()) %>%
  reactable( 
            groupBy = c("sex"),
            columns = list(
              N = colDef(aggregate = "sum")),
    bordered = TRUE,
    defaultExpanded = TRUE)
```

## Chromosome 15 Information

Things I'd like:

* Density of heterozygous SNPs per individual
* GC content of heterozygous positions

First let's look at the density of heterozygous positions in each sample, i.e. what fraction of the sites are heterozygous.

```{r}
df_subj_rel %>%
  tbl_summary(
    by = SUPER,
    include = c(frac_het, frac_het22, frac_het1),
    statistic = list(all_continuous() ~ "{mean} ({sd})", 
                     all_categorical() ~ "{n} / {N} ({p}%)"))

df_subj_rel %>%
  ggplot() +
  stat_density(aes(x = frac_het, colour = SUPER),
                  geom="line",position="identity") +
  theme_classic() +
  ggtitle("Fraction of Sites Heterozygous", "Chromosome 15") +
  labs(colour="Population") +
  xlab("Fraction of Sites Heterozygous") +
  scale_colour_manual(values=cbPalette)

df_subj_rel %>%
  ggplot() +
  stat_density(aes(x = frac_het22, colour = SUPER),
                  geom="line",position="identity") +
  theme_classic() +
  ggtitle("Fraction of Sites Heterozygous", "Chromosome 22") +
  labs(colour="Population") +
  xlab("Fraction of Sites Heterozygous") +
  scale_colour_manual(values=cbPalette)

df_subj_rel %>%
  ggplot() +
  stat_density(aes(x = frac_het1, colour = SUPER),
                  geom="line",position="identity") +
  theme_classic() +
  ggtitle("Fraction of Sites Heterozygous", "Chromosome 1") +
  labs(colour="Population") +
  xlab("Fraction of Sites Heterozygous") +
  scale_colour_manual(values=cbPalette)

df_subj_rel %>%
  ggplot() +
  geom_boxplot(aes(x = frac_het, y = SUPER , fill = SUPER), show.legend = FALSE) +
  theme_classic() +
  ggtitle("Fraction of Sites Heterozygous", "Chromosome 15") +
  labs(fill="Population") +
  xlab("Fraction of Sites Heterozygous") +
  ylab("Population") +
  scale_fill_manual(values=cbPalette)

df_subj_rel %>%
  ggplot() +
  geom_boxplot(aes(x = frac_het22, y = SUPER , fill = SUPER), show.legend = FALSE) +
  theme_classic() +
  ggtitle("Fraction of Sites Heterozygous", "Chromosome 22") +
  labs(fill="Population") +
  xlab("Fraction of Sites Heterozygous") +
  ylab("Population") +
  scale_fill_manual(values=cbPalette)

df_subj_rel %>%
  ggplot() +
  geom_boxplot(aes(x = frac_het1, y = SUPER , fill = SUPER), show.legend = FALSE) +
  theme_classic() +
  ggtitle("Fraction of Sites Heterozygous", "Chromosome 1") +
  labs(fill="Population") +
  xlab("Fraction of Sites Heterozygous") +
  ylab("Population") +
  scale_fill_manual(values=cbPalette)
```

How does this compare to what we observe in the X chromosome?

```{r}
sd_pair_info_df %>%
  tbl_summary(
    by = SP,
    include = c(frac_het),
    statistic = list(all_continuous() ~ "{mean} ({sd})", 
                     all_categorical() ~ "{n} / {N} ({p}%)"))

sd_pair_info_df %>%
  ggplot() +
  stat_density(aes(x = frac_het, colour = SP),
                  geom="line",position="identity") +
  theme_classic() +
  ggtitle("Fraction of Sites Heterozygous", "Chromosome X") +
  labs(colour="Population") +
  xlab("Fraction of Sites Heterozygous") +
  scale_colour_manual(values=cbPalette)

sd_pair_info_df %>%
  ggplot() +
  geom_boxplot(aes(x = frac_het, y = SP , fill = SP), show.legend = FALSE) +
  theme_classic() +
  ggtitle("Fraction of Sites Heterozygous", "Chromosome X") +
  labs(fill="Population") +
  xlab("Fraction of Sites Heterozygous") +
  ylab("Population") +
  scale_fill_manual(values=cbPalette)

sd_pair_info_df %>%
  ggplot() +
  geom_boxplot(aes(x = n_het, y = SP , fill = SP), show.legend = FALSE) +
  theme_classic() +
  ggtitle("Number of Heterozygous Sites", "Chromosome X") +
  labs(fill="Population") +
  xlab("Number of Heterozygous Sites") +
  ylab("Population") +
  scale_fill_manual(values=cbPalette)
```

And for another comparison, we'll summarize heterozygosity by super population:

```{r}
df_subj_rel %>%
  group_by(SUPER) %>%
  summarize(mean_het_15 = mean(frac_het),
            mean_het_22 = mean(frac_het22),
            mean_het_1 = mean(frac_het1)) %>%
  left_join({ sd_pair_info_df %>%
      group_by(SP) %>%
      summarize(mean_het_x = mean(frac_het))
  }, by = c("SUPER" = "SP")) %>%
  mutate(x_15_ratio = mean_het_x/mean_het_15,
         x_22_ratio = mean_het_x / mean_het_22,
         c15_22_ratio = mean_het_15 / mean_het_22,
         c15_1_ratio = mean_het_15 / mean_het_1) %>%
  knitr::kable()
```

And finally, since samples are shared between 15 and 22, let's look at how fraction of heterozygous sites looks like across chromosomes:

```{r}
df_subj_rel %>%
  ggplot(aes(frac_het, frac_het22, color = SUPER)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  theme_classic() +
  xlab("Chromosome 15 % Heterozygous") +
  ylab("Chromosome 22 % Heterozygous") +
  labs(color = "Population") +
  scale_color_manual(values = cbPalette)

df_subj_rel %>%
  ggplot(aes(frac_het, frac_het1, color = SUPER)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  theme_classic() +
  xlab("Chromosome 15 % Heterozygous") +
  ylab("Chromosome 1 % Heterozygous") +
  labs(color = "Population") +
  scale_color_manual(values = cbPalette)

df_subj_rel %>%
  ggplot(aes(frac_het22, frac_het1, color = SUPER)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  theme_classic() +
  xlab("Chromosome 22 % Heterozygous") +
  ylab("Chromosome 1 % Heterozygous") +
  labs(color = "Population") +
  scale_color_manual(values = cbPalette)
```

In addition, we also know how many heterozygous sites are triple heterozygous in each trio:

```{r}
df_subj_rel %>%
  ggplot(aes(x = frac_t_het, y = SUPER, fill = SUPER)) +
  geom_boxplot(show.legend = FALSE) +
  theme_classic() +
  xlab("Triple Het Site Fraction") +
  ylab("Population") +
  scale_fill_manual(values = cbPalette) +
  ggtitle("Fraction of heterozygous sites with triple heterozygotes", "Chromosome 15")

df_subj_rel %>%
  ggplot(aes(x = frac_t_het22, y = SUPER, fill = SUPER)) +
  geom_boxplot(show.legend = FALSE) +
  theme_classic() +
  xlab("Triple Het Site Fraction") +
  ylab("Population") +
  scale_fill_manual(values = cbPalette) +
  ggtitle("Fraction of heterozygous sites with triple heterozygotes", "Chromosome 22")

df_subj_rel %>%
  ggplot(aes(x = frac_t_het1, y = SUPER, fill = SUPER)) +
  geom_boxplot(show.legend = FALSE) +
  theme_classic() +
  xlab("Triple Het Site Fraction") +
  ylab("Population") +
  scale_fill_manual(values = cbPalette) +
  ggtitle("Fraction of heterozygous sites with triple heterozygotes", "Chromosome 1")

df_subj_rel %>%
  ggplot(aes(x = frac_t_het22, y = frac_t_het, color = SUPER)) +
  geom_point() +
  geom_abline(slope=1, intercept = 0) +
  theme_classic() +
  xlab("Chromosome 22") +
  ylab("Chromosome 15") +
  scale_color_manual(values = cbPalette) +
  ggtitle("Fraction of heterozygous sites with triple heterozygotes")

df_subj_rel %>%
  ggplot(aes(x = frac_t_het1, y = frac_t_het, color = SUPER)) +
  geom_point() +
  geom_abline(slope=1, intercept = 0) +
  theme_classic() +
  xlab("Chromosome 1") +
  ylab("Chromosome 15") +
  scale_color_manual(values = cbPalette) +
  ggtitle("Fraction of heterozygous sites with triple heterozygotes")

df_subj_rel %>%
  ggplot(aes(x = frac_t_het1, y = frac_t_het22, color = SUPER)) +
  geom_point() +
  geom_abline(slope=1, intercept = 0) +
  theme_classic() +
  xlab("Chromosome 1") +
  ylab("Chromosome 22") +
  scale_color_manual(values = cbPalette) +
  ggtitle("Fraction of heterozygous sites with triple heterozygotes")

df_subj_rel %>%
  ggplot(aes(x = n_t_het22, y = n_t_het, color = SUPER)) +
  geom_point() +
  theme_classic() +
  xlab("Chromosome 22") +
  ylab("Chromosome 15") +
  scale_color_manual(values = cbPalette) +
  ggtitle("Triple Heterozygous Sites")

df_subj_rel %>%
  ggplot(aes(x = n_t_het, y = SUPER, fill = SUPER)) +
  geom_boxplot(show.legend = FALSE) +
  theme_classic() +
  xlab("Triple Het Sites") +
  ylab("Population") +
  scale_fill_manual(values = cbPalette) +
  ggtitle("Triple Heterozygotes Sites", "Chromosome 15")
```


## Switch Errors

### Total Errors

```{r}
cross_meth_plot <- function(df, p_title, p_func, pop, chrom="15") {
  p1 <- p_func(df, "Beagle", "SHAPEIT", pop, chrom = chrom)
  p_legend <- cowplot::get_legend(p1)
  
  p1 <- p1 + guides(colour="none") + ggtitle(p_title, paste0("Chromosome ", chrom))
  
  p2 <- p_func(df, "Beagle", "Eagle", pop, chrom = chrom) +
    guides(colour="none") + ggtitle("", "")
  
  p3 <- p_func(df, "SHAPEIT", "Eagle", pop, chrom = chrom) +
    guides(colour="none") + ggtitle("", "")
  
  return(grid.arrange(p1, p_legend, p2, p3, ncol = 2))
  }

plot_total_errors <- function(df, m1, m2, pop, chrom="15"){
  p <- df %>%
    mutate(Beagle = (n_other_beagle + n_flip_beagle),
         Eagle =  (n_other_eagle + n_flip_eagle),
         SHAPEIT =  (n_other_shapeit + n_flip_shapeit)) %>%
    ggplot(aes(x = !! sym(m1), y = !! sym(m2), colour = !! sym(pop))) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    ggtitle("Total Errors", paste0("Chromosome ", chrom)) +
    theme_classic() +
    xlab(m1) +
    ylab(m2) +
    labs(color="Population") +
    scale_color_manual(values = cbPalette)
  return(p)
}

table_total_errors <- function(df, pop){
  res <- df %>%
    mutate(Beagle = (n_other_beagle + n_flip_beagle),
         Eagle =  (n_other_eagle + n_flip_eagle),
         SHAPEIT =  (n_other_shapeit + n_flip_shapeit)) %>%
    mutate(b_l_e = factor(Beagle < Eagle),
           b_e_e = factor(Beagle == Eagle),
           b_l_s = factor(Beagle < SHAPEIT),
           e_l_b = factor(Beagle > Eagle),
           e_l_s = factor(Eagle < SHAPEIT),
           s_l_b = factor(SHAPEIT < Beagle),
           s_l_e = factor(SHAPEIT < Eagle)) %>%
    tbl_summary(by = !! sym(pop),  
                include = c(b_l_e, b_e_e, b_l_s, e_l_b, e_l_s, s_l_b, s_l_e))
    
  return(res)
}

plot_total_errors(df_switch_trio, "Beagle", "Eagle", "SUPER")
plot_total_errors(df_switch_trio, "Beagle", "SHAPEIT", "SUPER")
plot_total_errors(df_switch_trio, "SHAPEIT", "Eagle", "SUPER")

cross_meth_plot(df_switch_trio, "Total Errors", plot_total_errors, "SUPER", "15")

table_total_errors(df_switch_trio, "SUPER")
```

And now chromosome 22:

```{r}
plot_total_errors(df_switch_trio_22, "Beagle", "Eagle", "SUPER", 22)
plot_total_errors(df_switch_trio_22, "Beagle", "SHAPEIT", "SUPER", 22)
plot_total_errors(df_switch_trio_22, "SHAPEIT", "Eagle", "SUPER", 22)

cross_meth_plot(df_switch_trio_22, "Total Errors", plot_total_errors, "SUPER", "22")

table_total_errors(df_switch_trio_22, "SUPER")
```

And now chromosome 1:

```{r}
plot_total_errors(df_switch_trio_1, "Beagle", "Eagle", "SUPER", 1)
plot_total_errors(df_switch_trio_1, "Beagle", "SHAPEIT", "SUPER", 1)
plot_total_errors(df_switch_trio_1, "SHAPEIT", "Eagle", "SUPER", 1)

cross_meth_plot(df_switch_trio_1, "Total Errors", plot_total_errors, "SUPER", "1")

table_total_errors(df_switch_trio_1, "SUPER")
```

And finally, chromosome X:

```{r}
plot_total_errors(df_switch_x, "Beagle", "Eagle", "pop", "X")
plot_total_errors(df_switch_x, "Beagle", "SHAPEIT", "pop", "X")
plot_total_errors(df_switch_x, "SHAPEIT", "Eagle", "pop", "X")

table_total_errors(df_switch_x, "pop")

cross_meth_plot(df_switch_trio, "Total Errors", plot_total_errors, "SUPER", "22")
```


#### Error Rate

```{r}
plot_total_rate <- function(df, m1, m2, pop, chrom="15"){
  p <- df %>%
    mutate(Beagle = (n_other_beagle + n_flip_beagle) / n_hets,
         Eagle = (n_other_eagle + n_flip_eagle) / n_hets,
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets) %>%
    ggplot(aes(x = !! sym(m1), y = !! sym(m2), colour = !! sym(pop))) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    ggtitle("Error Rate", paste0("Chromosome ", chrom)) +
    theme_classic() +
    xlab(m1) +
    ylab(m2) +
    labs(color="Population") +
    scale_color_manual(values = cbPalette)
  return(p)
}

plot_total_rate(df_switch_trio, "Beagle", "Eagle", "SUPER")
plot_total_rate(df_switch_trio, "Beagle", "SHAPEIT", "SUPER")
plot_total_rate(df_switch_trio, "SHAPEIT", "Eagle", "SUPER")

cross_meth_plot(df_switch_trio, "Total Errors", plot_total_rate, "SUPER", "15")
```

And now chromosome 22:

```{r}
plot_total_rate(df_switch_trio_22, "Beagle", "Eagle", "SUPER", 22)
plot_total_rate(df_switch_trio_22, "Beagle", "SHAPEIT", "SUPER", 22)
plot_total_rate(df_switch_trio_22, "SHAPEIT", "Eagle", "SUPER", 22)

cross_meth_plot(df_switch_trio_22, "Total Errors", plot_total_rate, "SUPER", "22")
```

And now chromosome 1:

```{r}
plot_total_rate(df_switch_trio_1, "Beagle", "Eagle", "SUPER", 1)
plot_total_rate(df_switch_trio_1, "Beagle", "SHAPEIT", "SUPER", 1)
plot_total_rate(df_switch_trio_1, "SHAPEIT", "Eagle", "SUPER", 1)

cross_meth_plot(df_switch_trio_1, "Total Errors", plot_total_rate, "SUPER", "1")
```

And finally, chromosome X:

```{r}
plot_total_rate(df_switch_x, "Beagle", "Eagle", "pop", "X")
plot_total_rate(df_switch_x, "Beagle", "SHAPEIT", "pop", "X")
plot_total_rate(df_switch_x, "SHAPEIT", "Eagle", "pop", "X")

cross_meth_plot(df_switch_x, "Total Errors", plot_total_rate, "pop", "X")
```

### Non-flip Switches

```{r}
plot_switches <- function(df, m1, m2, pop, chrom=15){
  p <- df %>%
    mutate(Beagle = n_other_beagle,
         Eagle = n_other_eagle,
         SHAPEIT = n_other_shapeit) %>%
    ggplot(aes(x = !! sym(m1), y = !! sym(m2), colour = !! sym(pop))) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    ggtitle("Switches", paste0("Chromosome ", chrom)) +
    theme_classic() +
    xlab(m1) +
    ylab(m2) +
    labs(color="Population") +
    scale_color_manual(values = cbPalette)
  return(p)
}

table_switches <- function(df, pop){
  res <- df %>%
    mutate(Beagle = (n_other_beagle ),
         Eagle =  (n_other_eagle),
         SHAPEIT =  (n_other_shapeit)) %>%
    mutate(b_l_e = factor(Beagle < Eagle),
           b_l_s = factor(Beagle < SHAPEIT),
           e_l_b = factor(Beagle > Eagle),
           e_l_s = factor(Eagle < SHAPEIT),
           s_l_b = factor(SHAPEIT < Beagle),
           s_l_e = factor(SHAPEIT < Eagle)) %>%
    tbl_summary(by = !! sym(pop),  
                include = c(b_l_e, b_l_s, e_l_b, e_l_s, s_l_b, s_l_e))
    
  return(res)
}

plot_switches(df_switch_trio, "Beagle", "Eagle", "SUPER")
plot_switches(df_switch_trio, "Beagle", "SHAPEIT", "SUPER")
plot_switches(df_switch_trio, "SHAPEIT", "Eagle", "SUPER")

table_switches(df_switch_trio, "SUPER")

cross_meth_plot(df_switch_trio, "Switches", plot_switches, "SUPER", "15")
```

And now chromosome 22:

```{r}
plot_switches(df_switch_trio_22, "Beagle", "Eagle", "SUPER", 22)
plot_switches(df_switch_trio_22, "Beagle", "SHAPEIT", "SUPER", 22)
plot_switches(df_switch_trio_22, "SHAPEIT", "Eagle", "SUPER", 22)

table_switches(df_switch_trio_22, "SUPER")

cross_meth_plot(df_switch_trio_22, "Switches", plot_switches, "SUPER", "22")
```

And now chromosome 1:

```{r}
plot_switches(df_switch_trio_1, "Beagle", "Eagle", "SUPER", 1)
plot_switches(df_switch_trio_1, "Beagle", "SHAPEIT", "SUPER", 1)
plot_switches(df_switch_trio_1, "SHAPEIT", "Eagle", "SUPER", 1)

table_switches(df_switch_trio_1, "SUPER")

cross_meth_plot(df_switch_trio_1, "Switches", plot_switches, "SUPER", "1")
```

And finally, chromosome X:

```{r}
plot_switches(df_switch_x, "Beagle", "Eagle", "pop", "X")
plot_switches(df_switch_x, "Beagle", "SHAPEIT", "pop", "X")
plot_switches(df_switch_x, "SHAPEIT", "Eagle", "pop", "X")

table_switches(df_switch_x, "pop")

cross_meth_plot(df_switch_x, "Switches", plot_switches, "pop", "X")
```

#### Switch Rate

```{r}
plot_switch_rate <- function(df, m1, m2, pop, chrom = 15){
  p <- df %>%
    mutate(Beagle = n_other_beagle / n_hets,
         Eagle = n_other_eagle / n_hets,
         SHAPEIT = n_other_shapeit / n_hets) %>%
    ggplot(aes(x = !! sym(m1), y = !! sym(m2), colour = !! sym(pop))) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    ggtitle("Switch Rate", paste0("Chromosome ", chrom)) +
    theme_classic() +
    xlab(m1) +
    ylab(m2) +
    labs(color="Population") +
    scale_color_manual(values = cbPalette)
  return(p)
}

plot_switch_rate(df_switch_trio, "Beagle", "Eagle", "SUPER")
plot_switch_rate(df_switch_trio, "Beagle", "SHAPEIT", "SUPER")
plot_switch_rate(df_switch_trio, "SHAPEIT", "Eagle", "SUPER")

cross_meth_plot(df_switch_trio, "Switches", plot_switch_rate, "SUPER", "15")
```

And now chromosome 22:

```{r}
plot_switch_rate(df_switch_trio_22, "Beagle", "Eagle", "SUPER", 22)
plot_switch_rate(df_switch_trio_22, "Beagle", "SHAPEIT", "SUPER", 22)
plot_switch_rate(df_switch_trio_22, "SHAPEIT", "Eagle", "SUPER", 22)
cross_meth_plot(df_switch_trio_22, "Switches", plot_switch_rate, "SUPER", "22")
```

And now chromosome 1:

```{r}
plot_switch_rate(df_switch_trio_1, "Beagle", "Eagle", "SUPER", 1)
plot_switch_rate(df_switch_trio_1, "Beagle", "SHAPEIT", "SUPER", 1)
plot_switch_rate(df_switch_trio_1, "SHAPEIT", "Eagle", "SUPER", 1)
cross_meth_plot(df_switch_trio_1, "Switches", plot_switch_rate, "SUPER", "1")
```

And finally, chromosome X:

```{r}
plot_switch_rate(df_switch_x, "Beagle", "Eagle", "pop", "X")
plot_switch_rate(df_switch_x, "Beagle", "SHAPEIT", "pop", "X")
plot_switch_rate(df_switch_x, "SHAPEIT", "Eagle", "pop", "X")

cross_meth_plot(df_switch_x, "Switches", plot_switch_rate, "pop", "X")
```

### Flips

```{r}
plot_flips <- function(df, m1, m2, pop, chrom = 15){
  p <- df %>%
    mutate(Beagle = n_flip_beagle,
         Eagle = n_flip_eagle,
         SHAPEIT = n_flip_shapeit) %>%
    ggplot(aes(x = !! sym(m1), y = !! sym(m2), colour = !! sym(pop))) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    ggtitle("Total Flips", paste0("Chromosome ", chrom)) +
    theme_classic() +
    xlab(m1) +
    ylab(m2) +
    labs(color="Population") +
    scale_color_manual(values = cbPalette)
  return(p)
}

table_flip <- function(df, pop){
  res <- df %>%
    mutate(Beagle = (n_flip_beagle ),
         Eagle =  (n_flip_eagle),
         SHAPEIT =  (n_flip_shapeit)) %>%
    mutate(b_l_e = factor(Beagle < Eagle),
           b_l_s = factor(Beagle < SHAPEIT),
           e_l_b = factor(Beagle > Eagle),
           e_l_s = factor(Eagle < SHAPEIT),
           s_l_b = factor(SHAPEIT < Beagle),
           s_l_e = factor(SHAPEIT < Eagle)) %>%
    tbl_summary(by = !! sym(pop),  
                include = c(b_l_e, b_l_s, e_l_b, e_l_s, s_l_b, s_l_e))
    
  return(res)
}

plot_flips(df_switch_trio, "Beagle", "Eagle", "SUPER")
plot_flips(df_switch_trio, "Beagle", "SHAPEIT", "SUPER")
plot_flips(df_switch_trio, "SHAPEIT", "Eagle", "SUPER")

table_flip(df_switch_trio, "SUPER")

cross_meth_plot(df_switch_trio, "Flips", plot_flips, "SUPER", "15")
```

And now chromosome 22:

```{r}
plot_flips(df_switch_trio_22, "Beagle", "Eagle", "SUPER", 22)
plot_flips(df_switch_trio_22, "Beagle", "SHAPEIT", "SUPER", 22)
plot_flips(df_switch_trio_22, "SHAPEIT", "Eagle", "SUPER", 22)

table_flip(df_switch_trio_22, "SUPER")

cross_meth_plot(df_switch_trio_22, "Flips", plot_flips, "SUPER", "22")
```

And now chromosome 1:

```{r}
plot_flips(df_switch_trio_1, "Beagle", "Eagle", "SUPER", 1)
plot_flips(df_switch_trio_1, "Beagle", "SHAPEIT", "SUPER", 1)
plot_flips(df_switch_trio_1, "SHAPEIT", "Eagle", "SUPER", 1)

table_flip(df_switch_trio_1, "SUPER")

cross_meth_plot(df_switch_trio_1, "Flips", plot_flips, "SUPER", "1")
```

And finally, chromosome X:

```{r}
plot_flips(df_switch_x, "Beagle", "Eagle", "pop", "X")
plot_flips(df_switch_x, "Beagle", "SHAPEIT", "pop", "X")
plot_flips(df_switch_x, "SHAPEIT", "Eagle", "pop", "X")

table_flip(df_switch_x, "pop")

cross_meth_plot(df_switch_x, "Flips", plot_flips, "pop", "X")
```

#### Flip Rate

```{r}
plot_flip_rate <- function(df, m1, m2, pop, chrom = 15){
  p <- df %>%
    mutate(Beagle = n_flip_beagle / n_hets,
         Eagle = n_flip_eagle / n_hets,
         SHAPEIT = n_flip_shapeit / n_hets) %>%
    ggplot(aes(x = !! sym(m1), y = !! sym(m2), colour = !! sym(pop))) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    ggtitle("Flip rate", paste0("Chromosome ", chrom)) +
    theme_classic() +
    xlab(m1) +
    ylab(m2) +
    labs(color="Population") +
    scale_color_manual(values = cbPalette)
  return(p)
}

plot_flip_rate(df_switch_trio, "Beagle", "Eagle", "SUPER")
plot_flip_rate(df_switch_trio, "Beagle", "SHAPEIT", "SUPER")
plot_flip_rate(df_switch_trio, "SHAPEIT", "Eagle", "SUPER")

cross_meth_plot(df_switch_trio, "Flips", plot_flip_rate, "SUPER", "15")
```

And now chromosome 22:

```{r}
plot_flip_rate(df_switch_trio_22, "Beagle", "Eagle", "SUPER", 22)
plot_flip_rate(df_switch_trio_22, "Beagle", "SHAPEIT", "SUPER", 22)
plot_flip_rate(df_switch_trio_22, "SHAPEIT", "Eagle", "SUPER", 22)

cross_meth_plot(df_switch_trio_22, "Flips", plot_flip_rate, "SUPER", "22")
```

And now chromosome 1:

```{r}
plot_flip_rate(df_switch_trio_1, "Beagle", "Eagle", "SUPER", 1)
plot_flip_rate(df_switch_trio_1, "Beagle", "SHAPEIT", "SUPER", 1)
plot_flip_rate(df_switch_trio_1, "SHAPEIT", "Eagle", "SUPER", 1)

cross_meth_plot(df_switch_trio_1, "Flips", plot_flip_rate, "SUPER", "1")
```

And finally, chromosome X:

```{r}
plot_flip_rate(df_switch_x, "Beagle", "Eagle", "pop", "X")
plot_flip_rate(df_switch_x, "Beagle", "SHAPEIT", "pop", "X")
plot_flip_rate(df_switch_x, "SHAPEIT", "Eagle", "pop", "X")

cross_meth_plot(df_switch_x, "Flips", plot_flip_rate, "pop", "X")
```

## Comparisons of Average Rates Across Chromosomes

### Switches

```{r}
df_pop_switch_rates <- df_switch_trio %>%
  mutate(Beagle = n_other_beagle / n_hets,
            Eagle = n_other_eagle / n_hets,
            SHAPEIT = n_other_shapeit / n_hets ) %>%
  group_by(SUPER) %>%
  summarize(Beagle15 = mean(Beagle),
            Eagle15 = mean(Eagle),
            SHAPEIT15 = mean(SHAPEIT)) %>%
  left_join({
    df_switch_x %>%
      mutate(Beagle = n_other_beagle / n_hets,
            Eagle = n_other_eagle / n_hets,
            SHAPEIT = n_other_shapeit / n_hets ) %>%
      group_by(pop) %>%
      summarize(BeagleX = mean(Beagle),
            EagleX = mean(Eagle),
            SHAPEITX = mean(SHAPEIT))
  }, by = c("SUPER" = "pop")) %>%
  left_join({
    df_switch_trio_22 %>%
      mutate(Beagle = n_other_beagle / n_hets,
             Eagle = n_other_eagle / n_hets,
             SHAPEIT = n_other_shapeit / n_hets) %>%
      group_by(SUPER) %>%
      summarize(Beagle22 = mean(Beagle),
                Eagle22 = mean(Eagle),
                SHAPEIT22 = mean(SHAPEIT))
  }, by="SUPER") %>% 
  left_join({
    df_switch_trio_1 %>%
      mutate(Beagle = n_other_beagle / n_hets,
             Eagle = n_other_eagle / n_hets,
             SHAPEIT = n_other_shapeit / n_hets) %>%
      group_by(SUPER) %>%
      summarize(Beagle1 = mean(Beagle),
                Eagle1 = mean(Eagle),
                SHAPEIT1 = mean(SHAPEIT))
  }, by="SUPER")

df_pop_switch_rates %>%
  knitr::kable()

df_pop_switch_rates %>%
  mutate(Beagle15_X = Beagle15 / BeagleX,
         Eagle15_X = Eagle15 / EagleX,
         SHAPEIT15_X = SHAPEIT15 / SHAPEITX,
         Beagle15_22 = Beagle15 / Beagle22,
         Eagle15_22 = Eagle15 / Eagle22,
         SHAPEIT15_22 = SHAPEIT15 / SHAPEIT22,
         Beagle15_1 = Beagle15 / Beagle1,
         Eagle15_1 = Eagle15 / Eagle1,
         SHAPEIT15_1 = SHAPEIT15 / SHAPEIT1) %>%
  select(SUPER, Beagle15_X, Eagle15_X, SHAPEIT15_X, 
         Beagle15_22, Eagle15_22, SHAPEIT15_22,
         Beagle15_1, Eagle15_1, SHAPEIT15_1) %>%
  knitr::kable()

df_pop_switch_rates %>%
  mutate(Beagle1_X = Beagle1 / BeagleX,
         Eagle1_X = Eagle1 / EagleX,
         SHAPEIT1_X = SHAPEIT1 / SHAPEITX,
         Beagle1_22 = Beagle1 / Beagle22,
         Eagle1_22 = Eagle1 / Eagle22,
         SHAPEIT1_22 = SHAPEIT1 / SHAPEIT22) %>%
  select(SUPER, Beagle1_X, Eagle1_X, SHAPEIT1_X, 
         Beagle1_22, Eagle1_22, SHAPEIT1_22) %>%
  knitr::kable()

df_pop_switch_rates %>%
  mutate(BeagleX_15 = BeagleX / Beagle15,
         EagleX_15 = EagleX / Eagle15,
         SHAPEITX_15= SHAPEITX / SHAPEIT15,
         Beagle22_15 = Beagle22 / Beagle15,
         Eagle22_15 = Eagle22 / Eagle15,
         SHAPEIT22_15 = SHAPEIT22 / SHAPEIT15,
         Beagle1_15 = Beagle1 / Beagle15,
         Eagle1_15 = Eagle1 / Eagle15,
         SHAPEIT1_15 = SHAPEIT1 / SHAPEIT15) %>%
  select(SUPER, BeagleX_15, EagleX_15, SHAPEITX_15, 
         Beagle22_15, Eagle22_15, SHAPEIT22_15,
         Beagle1_15, Eagle1_15, SHAPEIT1_15) %>%
  knitr::kable()
```

### Flips

```{r}
df_pop_flip_rates <- df_switch_trio %>%
  mutate(Beagle = n_flip_beagle / n_hets,
            Eagle = n_flip_eagle / n_hets,
            SHAPEIT = n_flip_shapeit / n_hets ) %>%
  group_by(SUPER) %>%
  summarize(Beagle15 = mean(Beagle),
            Eagle15 = mean(Eagle),
            SHAPEIT15 = mean(SHAPEIT)) %>%
  left_join({
    df_switch_x %>%
      mutate(Beagle = n_flip_beagle / n_hets,
            Eagle = n_flip_eagle / n_hets,
            SHAPEIT = n_flip_shapeit / n_hets ) %>%
      group_by(pop) %>%
      summarize(BeagleX = mean(Beagle),
            EagleX = mean(Eagle),
            SHAPEITX = mean(SHAPEIT))
  }, by = c("SUPER" = "pop")) %>%
  left_join({
    df_switch_trio_22 %>%
      mutate(Beagle = n_flip_beagle / n_hets,
             Eagle = n_flip_eagle / n_hets,
             SHAPEIT = n_flip_shapeit / n_hets) %>%
      group_by(SUPER) %>%
      summarize(Beagle22 = mean(Beagle),
                Eagle22 = mean(Eagle),
                SHAPEIT22 = mean(SHAPEIT))
  }, by="SUPER") %>% 
  left_join({
    df_switch_trio_1 %>%
      mutate(Beagle = n_flip_beagle / n_hets,
             Eagle = n_flip_eagle / n_hets,
             SHAPEIT = n_flip_shapeit / n_hets) %>%
      group_by(SUPER) %>%
      summarize(Beagle1 = mean(Beagle),
                Eagle1 = mean(Eagle),
                SHAPEIT1 = mean(SHAPEIT))
  }, by="SUPER")

df_pop_flip_rates %>%
  knitr::kable()

df_pop_flip_rates %>%
  mutate(Beagle15_X = Beagle15 / BeagleX,
         Eagle15_X = Eagle15 / EagleX,
         SHAPEIT15_X = SHAPEIT15 / SHAPEITX,
         Beagle15_22 = Beagle15 / Beagle22,
         Eagle15_22 = Eagle15 / Eagle22,
         SHAPEIT15_22 = SHAPEIT15 / SHAPEIT22,
         Beagle15_1 = Beagle15 / Beagle1,
         Eagle15_1 = Eagle15 / Eagle1,
         SHAPEIT15_1 = SHAPEIT15 / SHAPEIT1) %>%
  select(SUPER, Beagle15_X, Eagle15_X, SHAPEIT15_X, 
         Beagle15_22, Eagle15_22, SHAPEIT15_22,
         Beagle15_1, Eagle15_1, SHAPEIT15_1) %>%
  knitr::kable()

df_pop_flip_rates %>%
  mutate(Beagle1_X = Beagle1 / BeagleX,
         Eagle1_X = Eagle1 / EagleX,
         SHAPEIT1_X = SHAPEIT1 / SHAPEITX,
         Beagle1_22 = Beagle1 / Beagle22,
         Eagle1_22 = Eagle1 / Eagle22,
         SHAPEIT1_22 = SHAPEIT1 / SHAPEIT22) %>%
  select(SUPER, Beagle1_X, Eagle1_X, SHAPEIT1_X, 
         Beagle1_22, Eagle1_22, SHAPEIT1_22) %>%
  knitr::kable()

df_pop_flip_rates %>%
  mutate(BeagleX_15 = BeagleX / Beagle15,
         EagleX_15 = EagleX / Eagle15,
         SHAPEITX_15= SHAPEITX / SHAPEIT15,
         Beagle22_15 = Beagle22 / Beagle15,
         Eagle22_15 = Eagle22 / Eagle15,
         SHAPEIT22_15 = SHAPEIT22 / SHAPEIT15,
         Beagle1_15 = Beagle1 / Beagle15,
         Eagle1_15 = Eagle1 / Eagle15,
         SHAPEIT1_15 = SHAPEIT1 / SHAPEIT15) %>%
  select(SUPER, BeagleX_15, EagleX_15, SHAPEITX_15, 
         Beagle22_15, Eagle22_15, SHAPEIT22_15,
         Beagle1_15, Eagle1_15, SHAPEIT1_15) %>%
  knitr::kable()
```

## Error rates and triple het rate

Using only trio sequencing data, the phase of sites which are heterozygous in both the parents and in the child cannot be determined by the principles of Mendelian segregation. Below we explore the assocition between the frequency of triple heterozygous sites in each trio and the rate of errors in phasing of the child.

### Switch rate

#### Beagle

```{r}
plot_th_sr <- function(df, m1, chrom = 15, het_var = "n_t_het"){
  df <- df %>%
    mutate(Beagle = n_other_beagle / n_hets,
           Eagle = n_other_eagle / n_hets,
           SHAPEIT = n_other_shapeit / n_hets,
           frac_t_het = !! sym(het_var) / n_hets)
  c_val <- signif(cor(df[m1], df["frac_t_het"]), 4)
  c_obj <- cor.test(df[[m1]], df[["frac_t_het"]])
  p_val <- paste0("p=",signif(c_obj$p.value, 4))
  p <- df %>%
    ggplot(aes(x = frac_t_het, y = !! sym(m1), color = SUPER)) +
    geom_point() +
    xlab("Fraction of sites triple heterozygous") +
    ylab("Switch Error Rate") +
    scale_color_manual(values = cbPalette) +
    labs(color="Population") +
    ggtitle("Switch error rates and triple heterozygotes", paste0("Chromosome ", chrom, "; corr = ", c_val, "(", p_val ,")"))
  return(p)
}

plot_th_sr(df_switch_trio, "Beagle")
plot_th_sr(df_switch_trio_22, "Beagle", 22, "n_t_het22")
plot_th_sr(df_switch_trio_1, "Beagle", 1, "n_t_het1")
```

And comparing the fraction of triple hets that are errors to frac of all sites that are errors:

```{r}
df_switch_trio %>%
  mutate(frac_t_het = (n_t_het / n_hets)) %>%
  ggplot(aes(x = frac_t_het, color = SUPER)) +
    geom_density() +
    xlab("Fraction of TH Het Sites") +
    scale_color_manual(values = cbPalette) +
    theme_classic() 

enrich_plot_switch <- function(df, chrom = 15, suffix = "") {
  b_var <- paste0("beagle_switch_th", suffix)
  e_var <- paste0("eagle_switch_th", suffix)
  s_var <- paste0("shapeit_switch_th", suffix)
  p <- df %>%
    mutate(Beagle = (!! sym(b_var) / n_other_beagle),
           Eagle = (!! sym(e_var) / n_other_eagle),
           SHAPEIT = (!! sym(s_var) / n_other_shapeit)) %>%
    select(SUPER, Eagle, Beagle, SHAPEIT) %>%
    pivot_longer(-SUPER, names_to = "Method", values_to = "enrich") %>%
    ggplot(aes(x = enrich, color = SUPER)) +
      geom_density() +
      xlab("Frac. switches at TH") +
      scale_color_manual(values = cbPalette) +
      theme_classic() +
    ggtitle(paste0("Chromosome ", chrom))
  return(p)
}
enrich_plot_switch(df_switch_trio)
enrich_plot_switch(df_switch_trio_22, 22, "22")
enrich_plot_switch(df_switch_trio_1, 1, "1")


enrich_plot_flip <- function(df, chrom = 15, suffix = "") {
  b_var <- paste0("beagle_flip_th", suffix)
  e_var <- paste0("eagle_flip_th", suffix)
  s_var <- paste0("shapeit_flip_th", suffix)
  p <- df %>%
    mutate(Beagle = (!! sym(b_var) / n_other_beagle),
           Eagle = (!! sym(e_var) / n_other_eagle),
           SHAPEIT = (!! sym(s_var) / n_other_shapeit)) %>%
    select(SUPER, Eagle, Beagle, SHAPEIT) %>%
    pivot_longer(-SUPER, names_to = "Method", values_to = "enrich") %>%
    ggplot(aes(x = enrich, color = SUPER)) +
      geom_density() +
      xlab("Frac. flips at TH") +
      scale_color_manual(values = cbPalette) +
      theme_classic() +
    ggtitle(paste0("Chromosome ", chrom))
  return(p)
}

enrich_plot_flip(df_switch_trio)
enrich_plot_flip(df_switch_trio_22,22, 22)
enrich_plot_flip(df_switch_trio_1,1, 1)


barplot_switch_th <- function(df, chrom = 15, suffix = "", het_var="n_t_het"){
  b_var <- paste0("beagle_switch_th", suffix)
  e_var <- paste0("eagle_switch_th", suffix)
  s_var <- paste0("shapeit_switch_th", suffix)
  p <- df %>%
  mutate(Beagle = (!! sym(b_var) / n_other_beagle) / (!! sym(het_var) / n_hets),
         Eagle = (!! sym(e_var) / n_other_eagle) / (!! sym(het_var) / n_hets),
         SHAPEIT = (!! sym(s_var) / n_other_shapeit) / (!! sym(het_var) / n_hets)) %>%
  select(SUPER, Eagle, Beagle, SHAPEIT) %>%
  pivot_longer(-SUPER, names_to = "Method", values_to = "enrich") %>%
  ggplot(aes(x = Method, y = enrich, color = SUPER)) +
    geom_boxplot() +
    ylab("Frac. switches at TH / Frac. Het. at TH") +
    scale_color_manual(values = cbPalette) +
    theme_classic() +
  geom_hline(yintercept = 1) +
    ggtitle(paste0("Chromosome ", chrom))
  return(p)
}

barplot_switch_th(df_switch_trio)
barplot_switch_th(df_switch_trio_22, 22, 22, "n_t_het22")
barplot_switch_th(df_switch_trio_1, 1, 1, "n_t_het1")

barplot_flip_th <- function(df, chrom = 15, suffix = "", het_var="n_t_het"){
  b_var <- paste0("beagle_flip_th", suffix)
  e_var <- paste0("eagle_flip_th", suffix)
  s_var <- paste0("shapeit_flip_th", suffix)
  p <- df %>%
  mutate(Beagle = (!! sym(b_var) / n_other_beagle) / (!! sym(het_var) / n_hets),
         Eagle = (!! sym(e_var) / n_other_eagle) / (!! sym(het_var) / n_hets),
         SHAPEIT = (!! sym(s_var) / n_other_shapeit) / (!! sym(het_var) / n_hets)) %>%
  select(SUPER, Eagle, Beagle, SHAPEIT) %>%
  pivot_longer(-SUPER, names_to = "Method", values_to = "enrich") %>%
  ggplot(aes(x = Method, y = enrich, color = SUPER)) +
    geom_boxplot() +
    ylab("Frac. switches at TH / Frac. Het. at TH") +
    scale_color_manual(values = cbPalette) +
    theme_classic() +
  geom_hline(yintercept = 1) +
    ggtitle(paste0("Chromosome ", chrom))
  return(p)
}

barplot_flip_th(df_switch_trio)
barplot_flip_th(df_switch_trio_22, 22, 22, "n_t_het22")
barplot_flip_th(df_switch_trio_1, 1, 1, "n_t_het1")
```


#### Eagle

```{r}
plot_th_sr(df_switch_trio, "Eagle")
```

#### SHAPEIT

```{r}
plot_th_sr(df_switch_trio, "SHAPEIT")
```

### Flip Rate

#### Beagle
```{r}
plot_th_fr <- function(df, m1, chrom = 15){
  df <- df %>%
    mutate(Beagle = n_flip_beagle / n_hets,
           Eagle = n_flip_eagle / n_hets,
           SHAPEIT = n_flip_shapeit / n_hets,
           frac_t_het = n_t_het / n_hets)
  c_val <- signif(cor(df[m1], df["frac_t_het"]), 4)
  c_obj <- cor.test(df[[m1]], df[["frac_t_het"]])
  p_val <- paste0("p=",signif(c_obj$p.value, 4))
  p <- df %>%
    ggplot(aes(x = frac_t_het, y = !! sym(m1), color = SUPER)) +
    geom_point() +
    xlab("Fraction of sites triple heterozygous") +
    ylab("Flip Error Rate") +
    scale_color_manual(values = cbPalette) +
    labs(color="Population") +
    ggtitle("Flip error rates and triple heterozygotes", paste0("Chromosome ", chrom, "; corr = ", c_val, "(", p_val ,")"))
  return(p)
}

plot_th_fr(df_switch_trio, "Beagle")
```

#### Eagle

```{r}
plot_th_fr(df_switch_trio, "Eagle")
```

#### SHAPEIT

```{r}
plot_th_fr(df_switch_trio, "SHAPEIT")
```

## Enrichment at CpG

```{r}
df_switch_trio %>%
  summarize(mean_switch_eagle = mean(n_other_cpg_eagle),
            mean_switch_beagle = mean(n_other_cpg_beagle),
            mean_switch_shapeit = mean(n_other_cpg_shapeit),
            mean_flip_eagle = mean(n_flip_cpg_eagle),
            mean_flip_beagle = mean(n_flip_cpg_beagle),
            mean_flip_shapeit = mean(n_flip_cpg_shapeit)) %>%
  knitr::kable()

df_switch_trio %>%
  group_by(SUPER) %>%
  summarize(mean_switch_eagle = mean(n_other_cpg_eagle),
            mean_switch_beagle = mean(n_other_cpg_beagle),
            mean_switch_shapeit = mean(n_other_cpg_shapeit),
            mean_flip_eagle = mean(n_flip_cpg_eagle),
            mean_flip_beagle = mean(n_flip_cpg_beagle),
            mean_flip_shapeit = mean(n_flip_cpg_shapeit)) %>%
  knitr::kable()

df_switch_trio %>%
  summarize(mean_switch_eagle = mean(n_other_cpg_eagle / n_other_eagle),
            mean_switch_beagle = mean(n_other_cpg_beagle / n_other_beagle),
            mean_switch_shapeit = mean(n_other_cpg_shapeit / n_other_shapeit),
            mean_flip_eagle = mean(n_flip_cpg_eagle / n_flip_eagle),
            mean_flip_beagle = mean(n_flip_cpg_beagle / n_flip_beagle),
            mean_flip_shapeit = mean(n_flip_cpg_shapeit / n_flip_shapeit)) %>%
  knitr::kable()
```

```{r}
df_switch_trio %>%
  summarize(mean_switch_eagle = mean((n_other_cpg_eagle / n_other_eagle) / ( n_het_cpg / n_hets)),
            mean_switch_beagle = mean((n_other_cpg_beagle / n_other_beagle) / ( n_het_cpg / n_hets)),
            mean_switch_shapeit = mean((n_other_cpg_shapeit / n_other_shapeit) / ( n_het_cpg / n_hets) ),
            mean_flip_eagle = mean((n_flip_cpg_eagle / n_flip_eagle) / ( n_het_cpg / n_hets)),
            mean_flip_beagle = mean((n_flip_cpg_beagle / n_flip_beagle) / ( n_het_cpg / n_hets)),
            mean_flip_shapeit = mean((n_flip_cpg_shapeit / n_flip_shapeit) / ( n_het_cpg / n_hets))) %>%
  knitr::kable()
```

```{r}
df_switch_trio %>%
  mutate( prop_cpg_beagle =  n_other_cpg_beagle / n_other_beagle,
             prop_cpg_eagle =  n_other_cpg_eagle / n_other_eagle,
             prop_cpg_shapeit =  n_other_cpg_shapeit / n_other_shapeit) %>%
  mutate(ods_beagle = prop_cpg_beagle / (1 - prop_cpg_beagle),
         ods_eagle = prop_cpg_eagle / (1 - prop_cpg_eagle),
         ods_shapeit = prop_cpg_shapeit / (1 - prop_cpg_shapeit),
         ods_het = ( n_het_cpg / n_hets) / (1 - ( n_het_cpg / n_hets))) %>%
  mutate(Beagle = ods_beagle / ods_het,
         Eagle = ods_eagle / ods_het,
         SHAPEIT = ods_shapeit / ods_het) %>%
  select(SUPER, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(-SUPER, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR, colour = SUPER)) +
  geom_boxplot() +
  ylab("Odds CpG Switch / Odds CpG Het") +
  ggtitle("Odds Ratio of CpG Status for Switches") +
  theme_classic() +
  labs(colour = "Population") +
  scale_color_manual(values = cbPalette) +
  geom_hline(yintercept = 1, linetype=2)

df_switch_trio %>%
  mutate( prop_cpg_beagle =  n_other_cpg_beagle / n_other_beagle,
             prop_cpg_eagle =  n_other_cpg_eagle / n_other_eagle,
             prop_cpg_shapeit =  n_other_cpg_shapeit / n_other_shapeit) %>%
  mutate(ods_beagle = prop_cpg_beagle / (1 - prop_cpg_beagle),
         ods_eagle = prop_cpg_eagle / (1 - prop_cpg_eagle),
         ods_shapeit = prop_cpg_shapeit / (1 - prop_cpg_shapeit),
         ods_het = ( n_het_cpg / n_hets) / (1 - ( n_het_cpg / n_hets))) %>%
  mutate(Beagle = ods_beagle / ods_het,
         Eagle = ods_eagle / ods_het,
         SHAPEIT = ods_shapeit / ods_het) %>%
  select(SUPER, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(-SUPER, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR)) +
  geom_boxplot() +
  ylab("Odds CpG Switch / Odds CpG Het") +
  ggtitle("Odds Ratio of CpG Status for Switches") +
  theme_classic() +
  scale_color_manual(values = cbPalette) +
  geom_hline(yintercept = 1, linetype=2)
```

And flips:

```{r}
df_switch_trio %>%
  mutate( prop_cpg_beagle =  n_flip_cpg_beagle / n_flip_beagle,
             prop_cpg_eagle =  n_flip_cpg_eagle / n_flip_eagle,
             prop_cpg_shapeit =  n_flip_cpg_shapeit / n_flip_shapeit) %>%
  mutate(ods_beagle = prop_cpg_beagle / (1 - prop_cpg_beagle),
         ods_eagle = prop_cpg_eagle / (1 - prop_cpg_eagle),
         ods_shapeit = prop_cpg_shapeit / (1 - prop_cpg_shapeit),
         ods_het = ( n_het_cpg / n_hets) / (1 - ( n_het_cpg / n_hets))) %>%
  mutate(Beagle = ods_beagle / ods_het,
         Eagle = ods_eagle / ods_het,
         SHAPEIT = ods_shapeit / ods_het) %>%
  select(SUPER, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(-SUPER, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR, colour = SUPER)) +
  geom_boxplot() +
  ylab("Odds CpG Switch / Odds CpG Het") +
  ggtitle("Odds Ratio of CpG Status for Switches") +
  theme_classic() +
  labs(colour = "Population") +
  scale_color_manual(values = cbPalette) +
  geom_hline(yintercept = 1, linetype=2)

df_switch_trio %>%
  mutate( prop_cpg_beagle =  n_flip_cpg_beagle / n_flip_beagle,
             prop_cpg_eagle =  n_flip_cpg_eagle / n_flip_eagle,
             prop_cpg_shapeit =  n_flip_cpg_shapeit / n_flip_shapeit) %>%
  mutate(ods_beagle = prop_cpg_beagle / (1 - prop_cpg_beagle),
         ods_eagle = prop_cpg_eagle / (1 - prop_cpg_eagle),
         ods_shapeit = prop_cpg_shapeit / (1 - prop_cpg_shapeit),
         ods_het = ( n_het_cpg / n_hets) / (1 - ( n_het_cpg / n_hets))) %>%
  mutate(Beagle = ods_beagle / ods_het,
         Eagle = ods_eagle / ods_het,
         SHAPEIT = ods_shapeit / ods_het) %>%
  select(SUPER, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(-SUPER, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR)) +
  geom_boxplot() +
  ylab("Odds CpG Switch / Odds CpG Het") +
  ggtitle("Odds Ratio of CpG Status for Switches") +
  theme_classic() +
  scale_color_manual(values = cbPalette) +
  geom_hline(yintercept = 1, linetype=2)

```

## MAF Bins

In the `maf_prop_df` data frame, we have for each synthetic diploid the proportion of heterozygous sites that are: rare variants (maf < 0.01); uncommon variants (0.01 < maf < 0.05); and common variants (maf > 0.05). We also have these proportions for each type of error for each method (switch; flip start; flip end; correct).

Let's first look at the distributions of these proportions for all heterozygous positions within each individual:

```{r}
prop_maf_fig <- function(cat_type, title_text){
  df <- maf_prop_df %>%
    filter(str_detect(category, paste0("^", cat_type, "_[rcu]"))) %>%
    mutate(category = factor(category)) %>%
    mutate(category = fct_recode(category, "Rare" = paste0(cat_type, "_rare"),
                               "Uncommon" = paste0(cat_type, "_uncommon"),
                               "Common" = paste0(cat_type, "_common"))) %>%
    mutate(category = fct_relevel(category, c("Rare", "Uncommon", "Common")))
  
  p <- df %>%
    ggplot(aes(x = category, y = proportion, color = SUPER)) +
    geom_boxplot() +
    ggtitle(paste0(title_text, " in MAF Bins")) +
    xlab("") +
    ylab("Proportion of Sites") +
    theme_classic() +
    labs(color = "Population") +
    scale_color_manual(values = cbPalette)
  
  tab_prop <- df %>%
    group_by(SUPER, category) %>%
    summarize(mean_prop = mean(proportion))
  
  return(list(p = p, tab_prop = tab_prop))
}

res_obj <- prop_maf_fig("het", "Heterozygous Sites")
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### Beagle Errors

#### Switches

```{r}
cat_type <- "beagle_switch"
title_text <- "Beagle Switches"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### Flips

#### Start

```{r}
cat_type <- "beagle_flip"
title_text <- "Beagle Flips"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

#### End

```{r}
cat_type <- "beagle_flip end"
title_text <- "Beagle Flip Ends"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### Eagle Errors

#### Switches

```{r}
cat_type <- "eagle_switch"
title_text <- "Eagle Switches"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### Flips

#### Start

```{r}
cat_type <- "eagle_flip"
title_text <- "Eagle Flips"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

#### End

```{r}
cat_type <- "eagle_flip end"
title_text <- "Eagle Flip Ends"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### SHAPEIT Errors

#### Switches

```{r}
cat_type <- "shapeit_switch"
title_text <- "SHAPEIT Switches"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### Flips

#### Start

```{r}
cat_type <- "shapeit_flip"
title_text <- "SHAPEIT Flips"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

#### End

```{r}
cat_type <- "shapeit_flip end"
title_text <- "SHAPEIT Flip Ends"

res_obj <- prop_maf_fig(cat_type, title_text)
print(res_obj$p)

res_obj$tab_prop %>%
  knitr::kable()
```

### Odds Ratios

Here we'll compoute the ratio of odds of being in the rare variant category for errors and all heterozygous positions within each individual.

```{r}
maf_prop_df %>%
  select(category, proportion, id, SUPER) %>%
  pivot_wider(names_from = category, values_from = proportion) %>%
  mutate(or_het = het_rare / (1 - het_rare),
         or_b_s = beagle_switch_rare / (1 - beagle_switch_rare),
         or_e_s = eagle_switch_rare / (1 - eagle_switch_rare),
         or_s_s = shapeit_switch_rare / (1 - shapeit_switch_rare)) %>%
  mutate(Beagle = or_b_s / or_het,
         Eagle = or_e_s / or_het,
         SHAPEIT = or_s_s / or_het) %>%
  select(id, SUPER, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(!id & !SUPER, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR, colour = SUPER)) +
  geom_boxplot() +
  ggtitle("Odds Ratio of Rare Variant") +
  ylab("Odds Rare Switch / Odds Rare Heterozygous") +
  theme_classic() +
  labs(colour = "Population") +
  geom_hline(yintercept = 1, linetype = 2)
```

```{r}
maf_prop_df %>%
  select(category, proportion, id, SUPER) %>%
  pivot_wider(names_from = category, values_from = proportion) %>%
  mutate(or_het = het_rare / (1 - het_rare),
         or_b_s = beagle_flip_rare / (1 - beagle_flip_rare),
         or_e_s = eagle_flip_rare / (1 - beagle_flip_rare),
         or_s_s = shapeit_flip_rare / (1 - beagle_flip_rare)) %>%
  mutate(Beagle = or_b_s / or_het,
         Eagle = or_e_s / or_het,
         SHAPEIT = or_s_s / or_het) %>%
  select(id, SUPER, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(!id & !SUPER, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR, colour = SUPER)) +
  geom_boxplot() +
  ggtitle("Odds Ratio of Rare Variant") +
  ylab("Odds Rare Flip / Odds Rare Heterozygous") +
  theme_classic() +
  labs(colour = "Population") +
  geom_hline(yintercept = 1, linetype = 2)
```

### Enrichment

Instead of odds ratios, we compare the ratio of switches that are rare to the ratio of total heterozygous positions that are rare

```{r}
maf_prop_df %>%
  select(category, proportion, id, SUPER) %>%
  pivot_wider(names_from = category, values_from = proportion) %>%
  mutate(Beagle = beagle_switch_rare / het_rare,
         Eagle = eagle_switch_rare / het_rare,
         SHAPEIT = shapeit_switch_rare / het_rare) %>%
  select(id, SUPER, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(!id & !SUPER, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR, colour = SUPER)) +
  geom_boxplot() +
  ggtitle("Ratio of Proportions Rare") +
  ylab("Fraction Switch Rare / Fraction Het Rare") +
  theme_classic() +
  labs(colour = "Population") +
  geom_hline(yintercept = 1, linetype = 2)
```

```{r}
maf_prop_df %>%
  select(category, proportion, id, SUPER) %>%
  pivot_wider(names_from = category, values_from = proportion) %>%
  mutate(Beagle = beagle_flip_rare / het_rare,
         Eagle = eagle_flip_rare / het_rare,
         SHAPEIT = shapeit_flip_rare / het_rare) %>%
  select(id, SUPER, Beagle, Eagle, SHAPEIT) %>%
  pivot_longer(!id & !SUPER, names_to = "Method", values_to = "OR") %>%
  ggplot(aes(x = Method, y = OR, colour = SUPER)) +
  geom_boxplot() +
  ggtitle("Ratio of Proportions Rare") +
  ylab("Fraction Flip Rare / Fraction Het Rare") +
  theme_classic() +
  labs(colour = "Population") +
  geom_hline(yintercept = 1, linetype = 2)
```

## deCODE recombination rates

```{r}
df_decode %>%
  mutate(bin = ceiling(start / 1e6)) %>%
  group_by(bin) %>%
  summarize(cM_MB = mean(cM_MB))
```
