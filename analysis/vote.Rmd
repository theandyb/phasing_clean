---
title: "Voting Method Results"
author: "Andy Beck"
date: "2024-06-27"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r, message=FALSE, warning=FALSE, results = 'hide'}
library(tidyverse)
library(grid)
library(gridExtra) 
library(yaml)

library(ggpubfigs)
pal_choice <- "vibrant_seven"


config_obj <- yaml::read_yaml("_config.yaml")
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000")

theme_andy <- function(){
  theme_bw() +
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      text = element_text(size=14)
    )
}
```


## Subject Information

### Chromosome X Synthetic Diploids

```{r}
sample_info_df <- read_csv("data/1kgp/subject_info.csv") %>%
  select(SAMPLE_NAME, POPULATION, SUPER)

pair_info_df <- read_delim("data/sample_pairs.csv", col_names = c("POP", "ID1", "ID2"))
pair_info_df <- left_join(pair_info_df, sample_info_df, by = c("ID1"="SAMPLE_NAME")) %>%
  rename(SP = SUPER) %>%
  select(-POPULATION)

pair_info_df$pair_id <- 1:1000
```

### Trio Probands

```{r}
ped_df <- read_table("data/1kgp/1kGP.3202_samples.pedigree_info.txt")

child_ids <- ped_df %>% filter(fatherID != "0" & motherID != "0") %>% pull(sampleID)
unrel_ids <- scan("data/1kgp/unrelated_subjects.txt", what = character())

df_subj_rel <- sample_info_df %>%
  filter(SAMPLE_NAME %in% child_ids)
df_subj_rel$id2 <- 1:602

df_subj_unrel <- sample_info_df %>%
  filter(SAMPLE_NAME %in% unrel_ids)
```


## Chromosome X Results

```{r}
df_switch_x <- read_csv(paste0(config_obj$base_dir, "/output/switch_errors/switch_errors/summary.csv"), show_col_types = F)

df_vote_x <- read_csv(paste0(config_obj$base_dir, "/output/vote_x/summary.csv"), show_col_types = F)
```

Let's first look at the number of switches and flips per synthetic diploid across methods:

```{r}
df_x <- df_switch_x %>%
  select(((contains("n_other") | contains("n_flip")) & !contains("cpg")), pair_id) %>%
  pivot_longer(-pair_id, names_to = c("drop","error", "method"), names_sep = "_", values_to = "n") %>%
  select(-drop) %>%
  pivot_wider(names_from = "error", values_from = "n", id_cols = c("pair_id","method")) %>%
  rename(switches = other) %>%
  bind_rows({
    df_vote_x %>%
      select(((contains("n_other") | contains("n_flip")) & !contains("cpg")), pair_id) %>%
      pivot_longer(-pair_id, names_to = c("drop","error", "method"), names_sep = "_", values_to = "n") %>%
      select(-drop) %>%
      pivot_wider(names_from = "error", values_from = "n", id_cols = c("pair_id","method")) %>%
      rename(switches = other)
  }) %>%
  arrange(pair_id)

df_x <- df_x %>%
  left_join({pair_info_df %>% select(pair_id, SP)})

df_x %>%
  pivot_longer(switches:flip, names_to = "error_type", values_to = "n") %>%
  mutate(method = factor(method, levels = c("beagle", "eagle", "shapeit", "vote"), labels = c("Beagle", "Eagle", "SHAPEIT", "Vote"))) %>%
  ggplot(aes(x = error_type, y = n, color = method)) +
  geom_boxplot() +
  xlab("Error Type") +
  ylab("Errors") +
  scale_color_manual(values = friendly_pal(pal_choice)) +
  labs(color = "Method") +
  theme_andy()
```

Let's see if there are population level differences:

```{r}
df_x %>%
  ggplot(aes(x = method, y = switches, colour = SP)) +
  geom_boxplot() +
  xlab("Method") +
  ylab("Switches") +
  labs(colour = "Population") +
  scale_color_manual(values = friendly_pal(pal_choice)) +
  theme_andy()

df_x %>%
  ggplot(aes(x = method, y = flip, colour = SP)) +
  geom_boxplot() +
  xlab("Method") +
  ylab("Flips") +
  labs(colour = "Population") +
  scale_color_manual(values = friendly_pal(pal_choice)) +
  theme_andy()
```

Total Errors:

```{r}
df_switch_x %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) / n_hets,
         Eagle = (n_other_eagle + n_flip_eagle) / n_hets,
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets) %>%
  select(Beagle, Eagle, SHAPEIT, pair_id) %>%
  pivot_longer(-pair_id, names_to = "method", values_to = "rate") %>% 
  bind_rows({
    df_vote_x %>%
      mutate(Vote = (n_other_vote + n_flip_vote) / n_hets) %>%
      select(Vote, pair_id) %>%
      pivot_longer(-pair_id, names_to = "method", values_to = "rate")
  }) %>%
  ggplot(aes(x = method, y = rate, fill = method)) +
  geom_violin() +
  geom_boxplot(width=0.1, color="black", alpha=0.2) +
  scale_fill_manual(values = friendly_pal(pal_choice)) +
  xlab("Method") +
  ylab("Total Error Rate")
```

Get average error rates for each method:

```{r}
df_switch_x %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) / n_hets,
         Eagle = (n_other_eagle + n_flip_eagle) / n_hets,
         SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets) %>%
  select(Beagle, Eagle, SHAPEIT, pair_id) %>%
  pivot_longer(-pair_id, names_to = "method", values_to = "rate") %>% 
  bind_rows({
    df_vote_x %>%
      mutate(Vote = (n_other_vote + n_flip_vote) / n_hets) %>%
      select(Vote, pair_id) %>%
      pivot_longer(-pair_id, names_to = "method", values_to = "rate")
  }) %>%
  group_by(method) %>%
  summarise(mean_rate = mean(rate),
            median_rate = median(rate)) %>%
  knitr::kable()
```

```{r}
# T test comparing Vote to others
df_vote_rates <- df_vote_x %>%
  mutate(Vote = (n_other_vote + n_flip_vote) / n_hets) %>%
  select(Vote, pair_id)
df_beagle_rates <- df_switch_x %>%
  mutate(Beagle = (n_other_beagle + n_flip_beagle) / n_hets) %>%
  select(Beagle, pair_id)
df_eagle_rates <- df_switch_x %>%
  mutate(Eagle = (n_other_eagle + n_flip_eagle) / n_hets) %>%
  select(Eagle, pair_id)
df_shapeit_rates <- df_switch_x %>%
  mutate(SHAPEIT = (n_other_shapeit + n_flip_shapeit) / n_hets) %>%
  select(SHAPEIT, pair_id)

df_result <- t.test(df_vote_rates$Vote, df_beagle_rates$Beagle, paired = TRUE) %>% 
  broom::tidy() %>% mutate(method_comp = "Vote vs Beagle") %>%
  bind_rows({
    t.test(df_vote_rates$Vote, df_eagle_rates$Eagle, paired = TRUE) %>%
      broom::tidy() %>% mutate(method_comp = "Vote vs Eagle")
  }) %>%
  bind_rows({
    t.test(df_vote_rates$Vote, df_shapeit_rates$SHAPEIT, paired = TRUE) %>%
      broom::tidy() %>% mutate(method_comp = "Vote vs SHAPEIT")
  })

df_result
```


Rates:

```{r}
df_x_rate <- df_switch_x %>%
  mutate(Beagle_Flip = n_flip_beagle / n_hets,
         Eagle_Flip = n_flip_eagle / n_hets,
         SHAPEIT_Flip = n_flip_shapeit / n_hets,
         Beagle_Switch = n_other_beagle / n_hets,
         Eagle_Switch = n_other_eagle / n_hets,
         SHAPEIT_Switch = n_other_shapeit / n_hets) %>%
  select(contains("Flip", ignore.case = F), contains("Switch", ignore.case = F), pair_id) %>%
  pivot_longer(-pair_id, names_to = c("method", "type"), names_sep = "_", values_to = "rate") %>%
  pivot_wider(names_from = "method", values_from = "rate", id_cols = c("pair_id","type")) %>%
  left_join({
    df_vote_x %>%
      mutate(Vote_Flip = n_flip_vote / n_hets,
             Vote_Switch = n_other_vote / n_hets) %>%
      select(contains("Flip", ignore.case = F), contains("Switch", ignore.case = F), pair_id) %>%
      pivot_longer(-pair_id, names_to = c("method", "type"), names_sep = "_", values_to = "rate") %>%
      pivot_wider(names_from = "method", values_from = "rate", id_cols = c("pair_id","type"))
  }, by = c("pair_id", "type")) %>%
  arrange(pair_id)

df_x_rate <- df_x_rate %>%
  left_join({pair_info_df %>% select(pair_id, SP)})

df_x_rate %>%
  pivot_longer(Beagle:Vote, names_to = "method", values_to = "rate") %>%
  mutate(method = factor(method, levels = c("Beagle", "Eagle", "SHAPEIT", "Vote"), labels = c("Beagle", "Eagle", "SHAPEIT", "Vote"))) %>%
  ggplot(aes(x = type, y = rate, color = method)) +
  geom_boxplot() +
  xlab("Error Type") +
  ylab("Error Rates") +
  scale_color_manual(values = friendly_pal(pal_choice)) +
  labs(color = "Method") +
  theme_andy()
```

Let's see if there are population-level differences:

```{r}
df_x_rate %>%
  pivot_longer(Beagle:Vote, names_to = "method", values_to = "rate") %>%
  mutate(method = factor(method, levels = c("Beagle", "Eagle", "SHAPEIT", "Vote"), labels = c("Beagle", "Eagle", "SHAPEIT", "Vote"))) %>%
  filter(type=="Switch") %>%
  ggplot(aes(x = method, y = rate, colour = SP)) +
  geom_boxplot() +
  xlab("Method") +
  ylab("Switch Rate") +
  labs(colour = "Population") +
  scale_colour_manual(values = friendly_pal(pal_choice)) +
  theme_bw()

df_x_rate %>%
  pivot_longer(Beagle:Vote, names_to = "method", values_to = "rate") %>%
  mutate(method = factor(method, levels = c("Beagle", "Eagle", "SHAPEIT", "Vote"), labels = c("Beagle", "Eagle", "SHAPEIT", "Vote"))) %>%
  filter(type=="Flip") %>%
  ggplot(aes(x = method, y = rate, colour = SP)) +
  geom_boxplot() +
  xlab("Method") +
  ylab("Flip Rate") +
  labs(colour = "Population") +
  scale_colour_manual(values = friendly_pal(pal_choice)) +
  theme_bw()
```

And finally, let's look at each pair of methods and each individual synthetic diploid:

```{r}
sub_plot <- function(df, x, y, x_lab, y_lab){
  p1 <- df %>%
    ggplot(aes(x = !! sym(x), y = !! sym(y), colour = SP)) +
    geom_point() +
    geom_abline(slope = 1, intercept = 0, linetype = "dotdash") +
    xlab(x_lab) +
    ylab(y_lab) +
    scale_color_manual(values = friendly_pal(pal_choice)) +
    labs(colour = "Population") +
    theme_classic()
  return(p1)
}

pairwise_plots <- function(df, type = "switches"){
  df_plot <- df %>%
    select(pair_id, SP, method, !! sym(type)) %>%
    pivot_wider(names_from = method, values_from = !! sym(type), id_cols = c("pair_id", "SP"))
  
  p1 <- sub_plot(df_plot, "vote", "beagle", "Vote", "Beagle")
  p_legend <- cowplot::get_legend(p1)
  p1 <- p1 + guides(colour="none")
  
  p2 <- sub_plot(df_plot, "shapeit", "beagle", "SHAPEIT", "Beagle") + guides(colour="none")
  p3 <- sub_plot(df_plot, "eagle", "beagle", "Eagle", "Beagle") + guides(colour="none")
  
  p4 <- sub_plot(df_plot, "vote", "eagle", "Vote", "Eagle") + guides(colour="none")
  p5 <- sub_plot(df_plot, "shapeit", "eagle", "SHAPEIT", "Eagle") + guides(colour="none")
  
  p6 <- sub_plot(df_plot, "vote", "shapeit", "Vote", "SHAPEIT") + guides(colour="none")
  
  return(grid.arrange(p1, p2, p3, p4, p5, p6, p_legend, 
               layout_matrix = rbind(c(1,2,3), c(4, 5, NA), c(6, NA, 7))))
}
```

```{r, fig.width=8, fig.height=8}
pairwise_plots(df_x, "switches")
```

```{r, fig.width=8, fig.height=7}
pairwise_plots(df_x, "flip")
```


## Chromosome 1

```{r}
chrom <- 1

get_autosome_vote_df <- function(chrom){
  df_switch_1 <- read_csv(paste0(config_obj$base_dir, 
                                 "/output/trio_phase_", chrom, "/switch_errors/summary.csv"), 
                          show_col_types = F)

  df_vote_1 <- read_csv(paste0(config_obj$base_dir, "/output/vote_", chrom, "/summary.csv"), show_col_types = F)

  df_1 <- df_switch_1 %>%
    select(((contains("n_other") | contains("n_flip")) & !contains("cpg")), pair_id, n_hets) %>%
    pivot_longer(-c(pair_id, n_hets), names_to = c("drop","error", "method"), names_sep = "_", values_to = "n") %>%
    select(-drop) %>%
    pivot_wider(names_from = "error", values_from = "n", id_cols = c("pair_id","method", "n_hets")) %>%
    rename(switches = other) %>%
    bind_rows({
      df_vote_1 %>%
        select(((contains("n_other") | contains("n_flip")) & !contains("cpg")), pair_id, n_hets) %>%
        pivot_longer(-c(pair_id, n_hets), names_to = c("drop","error", "method"), names_sep = "_", values_to = "n") %>%
        select(-drop) %>%
        pivot_wider(names_from = "error", values_from = "n", id_cols = c("pair_id","method", "n_hets")) %>%
        rename(switches = other)
    }) %>%
    arrange(pair_id)

  df_1 <- df_1 %>%
    left_join({df_subj_rel %>% select(id2, SUPER) %>% rename(pair_id = id2, SP = SUPER)})
  df_1
}

df_1 <- get_autosome_vote_df(1)
```

```{r}
df_1 %>%
  pivot_longer(switches:flip, names_to = "error_type", values_to = "n") %>%
  mutate(method = factor(method, levels = c("beagle", "eagle", "shapeit", "vote"), labels = c("Beagle", "Eagle", "SHAPEIT", "Vote"))) %>%
  mutate(rate = n / n_hets) %>%
  ggplot(aes(x = error_type, y = rate, color = method)) +
  geom_boxplot() +
  xlab("Error Type") +
  ylab("Error Rate\n Per Heterozygous Position") +
  scale_color_manual(values = friendly_pal(pal_choice)) +
  labs(color = "Method") + 
  theme_andy() +
  theme(legend.position = "inside",
        legend.position.inside = c(0.8, 0.8))
```

Let's see if there are population-level differences:

```{r}
df_1 %>%
  ggplot(aes(x = method, y = switches, colour = SP)) +
  geom_boxplot() +
  xlab("Method") +
  ylab("Switches") +
  labs(colour = "Population") +
  scale_colour_manual(values = friendly_pal(pal_choice)) +
  theme_andy()

df_1 %>%
  ggplot(aes(x = method, y = flip, colour = SP)) +
  geom_boxplot() +
  xlab("Method") +
  ylab("Flips") +
  labs(colour = "Population") +
  scale_colour_manual(values = friendly_pal(pal_choice)) +
  theme_andy()
```

```{r, fig.width=8, fig.height=8}
pairwise_plots(df_1, "switches")
```

```{r, fig.width=8, fig.height=7}
pairwise_plots(df_1, "flip")
```


## Chromosome 2

```{r}
df_2 <- get_autosome_vote_df(2)
```

```{r}
df_2 %>%
  mutate(switches = switches / n_hets,
         flip = flip / n_hets) %>%
  pivot_longer(switches:flip, names_to = "error_type", values_to = "n") %>%
  mutate(method = factor(method, levels = c("beagle", "eagle", "shapeit", "vote"), labels = c("Beagle", "Eagle", "SHAPEIT", "Vote"))) %>%
  ggplot(aes(x = error_type, y = n, color = method)) +
  geom_boxplot() +
  xlab("Error Type") +
  ylab("Error Rate") +
  scale_color_manual(values = friendly_pal(pal_choice)) +
  labs(color = "Method") +
  theme_andy() +
  theme(legend.position = "inside",
        legend.position.inside = c(0.8, 0.8))
```

```{r, fig.width=8, fig.height=8}
pairwise_plots(df_2, "switches")
```

```{r, fig.width=8, fig.height=7}
pairwise_plots(df_2, "flip")
```

## Chromosome 3

```{r}
autosome_analysis <- function(chrom){
  df <- get_autosome_vote_df(chrom)
  
  p1 <- df %>%
    mutate(switches = switches / n_hets,
           flip = flip / n_hets) %>%
    pivot_longer(switches:flip, names_to = "error_type", values_to = "n") %>%
    mutate(method = factor(method, levels = c("beagle", "eagle", "shapeit", "vote"), labels = c("Beagle", "Eagle", "SHAPEIT", "Vote"))) %>%
    ggplot(aes(x = error_type, y = n, color = method)) +
    geom_boxplot() +
    xlab("Error Type") +
    ylab("Error Rate") +
    scale_color_manual(values = friendly_pal(pal_choice)) +
    labs(color = "Method") +
    theme_andy() +
    theme(legend.position = "inside",
          legend.position.inside = c(0.8, 0.8))
  
  pairwise_plots(df, "switches")
  pairwise_plots(df, "flip")
  return(p1)
}
```

```{r}
chrom <- 3
autosome_analysis(chrom)
```

## Chromosome 4

```{r}
chrom <- 4
autosome_analysis(chrom)
```

## Chromosome 5

```{r}
chrom <- 5
autosome_analysis(chrom)
```

## Chromosome 6

```{r}
chrom <- 6
autosome_analysis(chrom)
```

## Chromosome 7

```{r}
chrom <- 7
autosome_analysis(chrom)
```

## Chromosome 8

```{r}
chrom <- 8
autosome_analysis(chrom)
```

## Chromosome 9

```{r}
chrom <- 9
autosome_analysis(chrom)
```

## Chromosome 10

```{r}
chrom <- 10
autosome_analysis(chrom)
```

## Chromosome 11

```{r}
chrom <- 11
autosome_analysis(chrom)
```

## Chromosome 12

```{r}
chrom <- 12
autosome_analysis(chrom)
```

## Chromosome 13

```{r}
chrom <- 13
autosome_analysis(chrom)
```

## Chromosome 14

```{r}
chrom <- 14
autosome_analysis(chrom)
```

## Chromosome 15

```{r}
chrom <- 15
autosome_analysis(chrom)
```

## Chromosome 16

```{r}
chrom <- 16
autosome_analysis(chrom)
```

## Chromosome 17

```{r}
chrom <- 17
autosome_analysis(chrom)
```

## Chromosome 18

```{r}
chrom <- 18
autosome_analysis(chrom)
```

## Chromosome 19

```{r}
chrom <- 19
autosome_analysis(chrom)
```

## Chromosome 20

```{r}
chrom <- 20
autosome_analysis(chrom)
```

## Chromosome 21

```{r}
chrom <- 21
autosome_analysis(chrom)
```

## Chromosome 22

```{r}
chrom <- 22
autosome_analysis(chrom)
```
